/*
 * this library depend on leafletjs ;
 * this public library
 * */(function(a){"Function"===typeof define?define(a()):a(Window.Rtmap||{})})(function(a){var B={airportpoi:{18:"\u673a\u573a\u76f8\u5173POI",isAirportpoi:function(a){return a?0==a.toString().indexOf("18")?!0:!1:!1}},restaurantpoi:{10:"\u9910\u996e\u76f8\u5173",isRestaurantPoi:function(a){return a?0==a.toString().indexOf("10")?!0:!1:!1}},businesspoi:{11:"\u670d\u9970\u978b\u5305",12:"\u8d2d\u7269\u76f8\u5173",13:"\u4f11\u95f2\u5a31\u4e50",isBusinessPoi:function(a){return a?0==a.toString().indexOf("11")||0==a.toString().indexOf("12")||0==a.toString().indexOf("13")?!0:!1:!1}},travelpoi:{180101:"\u56fd\u5185\u4e58\u673a\u624b\u7eed\u529e\u7406",180102:"\u56fd\u9645\u4e58\u673a\u624b\u7eed\u529e\u7406",180201:"\u5b89\u68c0",180301:"\u767b\u673a\u53e3",180502:"\u884c\u674e\u63d0\u53d6",isTravelPoi:function(a){return a?0==a.toString().indexOf("180101")||0==a.toString().indexOf("180102")||0==a.toString().indexOf("180201")||0==a.toString().indexOf("180301")||0==a.toString().indexOf("180502")?!0:!1:!1}},zoomHash:{15:[],16:[190206,2E5],17:[190206,180301,180402,180201,180101,2E5],18:[190206,1801,1802,1803,1804,2E5],19:[190206,18,10,11,12,13,14,15,2E5]},twoClassHash:{180301:"./public/img/boarding.png",180402:"./public/img/arrive.png",190206:"./public/img/doorway.png",190401:"./public/img/information_desk.png",190402:"./public/img/information_desk.png"},smallIconHash:{150704:"./public/img/tel.png",190101:"./public/img/wc.png",190201:"./public/img/elevator.png",190202:"./public/img/escalator.png",190203:"./public/img/stairway_new.png",190303:"./public/img/power.png"},largeIconHash:{180101:"./public/img/checkin.png",180102:"./public/img/checkin.png",180103:"./public/img/checkin.png",180104:"./public/img/checkin.png",180105:"./public/img/checkin.png",180106:"./public/img/fly.png",180107:"./public/img/fly.png",180108:"./public/img/fly.png",180109:"./public/img/ticket.png",180201:"./public/img/security.png",180202:"./public/img/customs.png",180203:"./public/img/borderdefence.png",180204:"./public/img/quarantine.png",180401:"./public/img/transfer.png",180501:"./public/img/luggageelated.png",180502:"./public/img/luggageclaim.png",180503:"./public/img/luggageelated.png",180505:"./public/img/luggageelated.png",200105:"./public/img/ticket.png"},getLayerStyle:function(a){a=a.feature;var l=a.properties.style;return Rtmap.Classification.travelpoi.isTravelPoi(a.properties.two_class)?{type:5,fillColor:"#e8c377",color:"#af7d0c",weight:.5,opacity:1,fillOpacity:1,hover:{fillColor:"#dddddd",color:"#e9bbba",weight:.5,opacity:1,fillOpacity:1}}:Rtmap.Classification.airportpoi.isAirportpoi(a.properties.two_class)?{type:5,fillColor:"#d0dee2",color:"#8eadc1",weight:.5,opacity:1,fillOpacity:1,hover:{fillColor:"#dddddd",color:"#e9bbba",weight:.5,opacity:1,fillOpacity:1}}:Rtmap.Classification.businesspoi.isBusinessPoi(a.properties.two_class)?{type:5,fillColor:"#d8e0ca",color:"#97a869",weight:.5,opacity:1,fillOpacity:1,hover:{fillColor:"#dddddd",color:"#e9bbba",weight:.5,opacity:1,fillOpacity:1}}:Rtmap.Classification.restaurantpoi.isRestaurantPoi(a.properties.two_class)?{type:5,fillColor:"#efe5ce",color:"#c9a659",weight:.5,opacity:1,fillOpacity:1,hover:{fillColor:"#dddddd",color:"#e9bbba",weight:.5,opacity:1,fillOpacity:1}}:Rtmap.Style.getStyleByPoiType(l)}};a.Classification=B;var D=L.Layer.extend({initialize:function(a,l,k,e){this._latlng=a;this._text=l;this.type=e;L.Util.setOptions(this,k)},options:{offset:new L.Point(0,2)},rePosition:function(a,l){var k={offset:new L.Point(a,l)};L.Util.setOptions(this,k)},moveToCenter:function(){this.getSize();var a=this._size.width,l=this._size.height;this.haveIcon?this.rePosition(-a/2,l/2):$(this._container).find("img").length?"smallIconWithText"==this._iconStyle?this.rePosition(-11,l/2):"largeIconWithText"==this._iconStyle?this.rePosition(-11,l/2):"smallIcon"==this._iconStyle?this.rePosition(-11,l/2):this.rePosition(-7.5,l/2):this.rePosition(-a/2,l/2);this._reset()},getCenterPoint:function(){return"smallIconWithText"==this._iconStyle||"largeIconWithText"==this._iconStyle?new L.Point(this._pos.x+this.getSize().width/2,this._pos.y):this._pos},getSize:function(){this._size||(this._size={width:this._container.clientWidth,height:this._container.clientHeight,padding_left:0});return this._size},getEvents:function(){return{zoom:this._reset,viewreset:this._reset,moveend:this._reset}},onAdd:function(a){this._map=a;this._container||this._initLayout();a.getPanes().overlayPane.appendChild(this._container);var l=Rtmap.Style.getImageConfig(this.two_class);l?(this.haveIcon=!0,this._text=null,this._container.innerHTML='\x3cimg src\x3d"'+l+'" width\x3d"18px" height\x3d"18px"\x3e'):(this.haveIcon=!1,this._container.innerHTML=this._text);a.on("viewreset",this._reset,this);this._reset()},onRemove:function(a){a.getPanes().overlayPane.removeChild(this._container);a.off("viewreset",this._reset,this)},_reset:function(){var a=this._map.latLngToLayerPoint(this._latlng);this._pos=a;a=new L.Point(a.x+this.options.offset.x,a.y-this.options.offset.y);L.DomUtil.setPosition(this._container,a)},addClass:function(a){$(this._container).addClass(a)},_initLayout:function(){a.Config.getOption().PoiStart?this.star=a.Config.getOption().PoiStart[this._text]||0:this.star=0;this._container=L.DomUtil.create("div","rtmap_room_name");if(a.Config.getOption().showIcon){var q=a.Config.getOption().PoiClass[this.class_extension];q&&(this.haveIcon=!0,$(this._container).addClass(q))}(q=a.Style.getGlobalConfig("font_color"))&&$(this._container).css({color:q})},_iconStyle:"none",_nowLayer:null,setDisplayStyle:function(){a.Config.getOption().largeScene&&this.filterByZoom(this._map.getZoom());"circle-point"!=a.Config.getOption().labelStyle?this._iconStyle="none":this.two_class&&(B.twoClassHash[this.two_class]?(this._container.innerHTML="\x3cimg src\x3d"+B.twoClassHash[this.two_class]+" width\x3d'22px'/\x3e"+this._container.textContent,this._iconStyle="smallIconWithText"):B.largeIconHash[this.two_class]?(this._container.innerHTML='\x3cimg src\x3d"'+B.largeIconHash[this.two_class]+'" width\x3d"22px" height\x3d"22px" style\x3d"position: absolute;" \x3e\x3cdiv\x3e'+this._text+"\x3c/div\x3e",this._iconStyle="largeIconWithText"):B.smallIconHash[this.two_class]&&(this._container.innerHTML='\x3cimg src\x3d"'+B.smallIconHash[this.two_class]+'" width\x3d"22px" height\x3d"22px"\x3e',this._iconStyle="smallIcon"));this.moveToCenter()},filterByZoom:function(a){if(a=B.zoomHash[a]){var l=!1;if(this.two_class)for(var k=this.two_class.toString(),e=0;e<a.length;e++)if(0==k.indexOf(a[e])){l=!0;break}l?this.iconLabelShow():this.iconLabelHide()}else this.iconLabelShow()},_labelHideStatus:!1,iconLabelHide:function(){this._labelHideStatus=!0},iconLabelShow:function(){this._labelHideStatus=!1},_geoBound:null,getBounds:function(){if(!this._geoBound){var a=this.getCenterPoint(),l=this._container.clientWidth,k=this._container.clientHeight,e=this._map.layerPointToLatLng([a.x-l/2,a.y-k/2]),a=this._map.layerPointToLatLng([a.x+l/2,a.y+k/2]);this._geoBound=L.latLngBounds(e,a)}return this._geoBound},setZoomVisble:function(a,l){this["zoom"+a+"visble"]=l},getZoomVisble:function(a){return this["zoom"+a+"visble"]}});a.Control=function(){var q=null,l=[],k=null,e=null,b=!0,c=null,h=null,y=function(){function h(){var f=localStorage.getItem("searchHistory");return f?f.split(","):[]}function p(){localStorage.setItem("searchHistory","")}function r(){g();y();w("clearSearchResult");z=c=null;a.Search.FocusResult=null;k&&(k?Rtmap.Scene.removeLayer(k,!0):"",k=null);Rtmap.Scene.SelectMarker?Rtmap.Scene.removeLayer(Rtmap.Scene.SelectMarker,!0):"";Rtmap.Scene.SelectMarker=null}function g(){x=null;u=1;b=!0;$(t.html).find(".resultListBox").hide();t.hideBackBtn();$(t.html).find(".searchInput").val("");$(t.html).find(".clearInput").hide();$(t.html).find(".resultListBox ul").html("");var f=Rtmap.Scene.SelectMarker;f?Rtmap.Scene.removeLayer(f,!0):"";Rtmap.Scene.SelectMarker=null;w("clearResultList")}function m(f){for(var a=localStorage.getItem("searchHistory"),a=a?a.split(","):[],c=0;c<a.length;c++)if(a[c]==f)return;a.push(f);5<a.length&&a.splice(0,a.length-5);try{localStorage.setItem("searchHistory",a)}catch(b){console.log("please turn off '\u65e0\u75d5\u6d4f\u89c8'!")}}function d(f){g();y();var c=[],b=a.Style.getGlobalConfig("focus_icon_url"),r=a.Style.getGlobalConfig("normal_icon_url"),m=L.icon({iconUrl:b,iconRetinaUrl:b,iconSize:[30,30],iconAnchor:[15,30],shadowSize:[68,95],shadowAnchor:[22,94]}),p=L.icon({iconUrl:r,iconRetinaUrl:r,iconSize:[30,30],iconAnchor:[15,30],shadowSize:[68,95],shadowAnchor:[22,94]});l.length=0;Rtmap.PoiLabelFactory.resetIconStatus();for(b=0;b<f.length;b++){var r=f[b].x,h=f[b].y,I=Rtmap.Scene.getPoiByNum(f[b].floor,f[b].poi_no);I&&(r=I.feature.properties.x_coord,h=I.feature.properties.y_coord);I=Rtmap.Scene.createMarker({icon:0==b?m:p,fillOpacity:1,opacity:1,fillColor:"red",color:"#ddd",size:10,x:r,y:h});l.push(I);I.on("click",function(){for(var f=0;f<l.length;f++)l[f].setIcon(p),delete l[f].selected;this.setIcon(m);this.selected=!0});0==b&&(I.selected=!0);r=L.CRS.EPSG3395.projection.unproject(new L.Point(r,h));c.push(r)}b=Rtmap.Scene.getMap();1<c.length||1==f.length&&Rtmap.Scene.moveTo({x:f[0].x,y:f[0].y},b.zoom);k?Rtmap.Scene.removeLayer(k,!0):"";Rtmap.Scene.removeLayer(k,!0);w("markerSearchToMap",[f,l])}function y(){for(var f=0;f<l.length;f++)Rtmap.Scene.removeLayer(l[f],!0)}function w(f,a){if(C[f])for(var b=0;b<C[f].length;b++)C[f][b].apply(self,a)}var t=null,u=1,x,z=null,B=L.Control.extend({option:{position:"topright"},bindEvent:function(){function f(){var f=$("\x3cul/\x3e"),a=h();if(1>a.length)$(v).find(".searchHistoryBox").hide();else{for(i=a.length-1;-1<i;i--){var b=$("\x3cli/\x3e",{text:a[i],"class":"history_item"});f.append(b);b.click(function(){c=$(this).text();$(v).find(".searchInput").blur();g();$(v).find(".searchInput").val(c);$(v).find(".clearInput").show();G()})}$(v).find(".searchHistoryBox ul").remove();$(v).find(".searchHistoryBox").show().prepend(f)}}function F(f){function c(f,a){f.click(function(){event.stopPropagation();var f=Rtmap.Scene.getNowFloor();a.floor.toLowerCase()!=f&&(w("changeToNearFloor",[a.floor]),Rtmap.Scene.changeFloorTo(a.floor));l(a);window.locationModel="free";Rtmap.Control.disableLocal()})}var g=$(v).find(".resultListBox");g.show();g=g.find("ul");b&&(g.html(""),g[0].scrollTop=0);for(var m=0;m<f.length;m++){var F=$("\x3cli/\x3e",{}),p='\x3cspan class\x3d"poi_name"\x3e'+f[m].name+'\x3c/span\x3e\x3cspan class\x3d"floor"\x3e'+a.Config.getFloorAliasName(f[m].floor)+"\x3c/span\x3e";F.append(p);g.append(F);c(F,f[m])}e=r}function l(f){k?Rtmap.Scene.removeLayer(k,!0):"";var b=a.Style.getGlobalConfig("focus_icon_url"),b=L.icon({iconUrl:b,iconRetinaUrl:b,iconSize:[30,30],iconAnchor:[15,30],shadowSize:[68,95],shadowAnchor:[22,94]});k=Rtmap.Scene.createMarker({x:f.x,y:f.y,icon:b});k.selected=!0;y();Rtmap.Scene.moveTo({x:f.x,y:f.y},19);var c=$(v).find(".resultListBox");c.hide();e=function(){c.show();e=r};z={};z.x=f.x;z.y=f.y;z.floor=f.floor;z.poi_no=f.poi_no;a.Search.FocusResult=z;w("markerSearchToMap",[[f],[k]])}function G(f,b){var g=c;-1<H.getCategoryList().concat(["\u7535\u68af"]).indexOf(g)&&(f="category");""!=g&&(f||m(g),a.Search.request({searchPageIndex:u,keyword:g,searchType:f,className:b||""},function(a,b,c){q=a;x=b.pagecount;if(!(u>x))if(b.poilist&&0<b.poilist.length)if("category"==f){a=Rtmap.Scene.getNowFloor();var g=q[a];g?d(g,c.className):(g=function(f,a){function b(f){f=f.toLowerCase();f=f.replace(/b/g,"-");f=f.replace(/f/g,"");return f=parseFloat(f)}function c(a){var b=f.indexOf(g+a),r=f.indexOf(g-a);return-1<b?b:-1<r?r:c(a+.5)}for(var g=b(a),r=0;r<f.length;r++)f[r]=b(f[r]);f.sort(function(f,a){return f-a});r=c(0);return f[r]},b.floor_result&&0<b.floor_result.length&&(b=g(b.floor_result,a),b=0<b?"f"+b:"b"+-b,w("changeToNearFloor",[b]),Rtmap.Scene.changeFloorTo(b,function(){G("category",c.className)}),x=null))}else F(b.poilist),H.showBackBtn();else r(),H.hideBackBtn()}))}function t(f,b){var c=b.attr("searchData");c?c=-1!=c.indexOf("_")?c.split("_"):[c]:console.log("no such data");a.Search.searchTwoClass(c,function(a,c){q=a;x=c.pagecount;if(c.poilist&&0<c.poilist.length)if("category"==f){var g=Rtmap.Scene.getNowFloor(),m=q[g];m?d(m):(m=function(f,a){function b(f){f=f.toLowerCase();f=f.replace(/b/g,"-");f=f.replace(/f/g,"");return f=parseFloat(f)}function c(a){var b=f.indexOf(g+a),r=f.indexOf(g-a);return-1<b?b:-1<r?r:c(a+.5)}for(var g=b(a),r=0;r<f.length;r++)f[r]=b(f[r]);f.sort(function(f,a){return f-a});r=c(0);return f[r]},c.floor_result&&0<c.floor_result.length&&(g=m(c.floor_result,g),g=0<g?"f"+g:"b"+-g,w("changeToNearFloor",[g]),Rtmap.Scene.changeFloorTo(g,null,function(){t("category",b)}),x=null))}else F(c.poilist),H.showBackBtn();else r(),H.hideBackBtn()})}var H=this,v=this.html;$(v).find(".searchBtn").click(function(f){f.stopPropagation();w("searchBtn",[f]);c=$(v).find(".searchInput").val().trim();x=null;b=!0;u=1;G()});$(v).find(".back").click(function(f){f.stopPropagation();e?e():""});Rtmap.Scene.on("mapDrag",function(){$(v).find(".searchInput").blur()});Rtmap.Scene.on("mapAction",function(){"follow"!=window.locationModel&&$(v).find(".category_box").slideUp()});Rtmap.Scene.on("poiClick",function(f,a){$(v).find(".searchInput").blur();$(v).find(".category_box").slideUp()});$(v).find(".searchInput").on("input",function(){event.stopPropagation();0<$(v).find(".searchInput").val().length?($(v).find(".clearInput").show(),$(v).find(".searchHistoryBox").hide()):($(v).find(".clearInput").hide(),0<h().length&&$(v).find(".searchHistoryBox").show());c=$(v).find(".searchInput").val().trim();x=null;b=!0;u=1;G()});$(v).find(".searchInput").click(function(f){f.stopPropagation()});$(v).find(".clearInput").click(function(f){f.stopPropagation();r()});$(v).find(".categoryBtn").click(function(f){f.stopPropagation();$(v).find(".searchInput").blur();$(v).find(".category_box").slideToggle();w("categoryBtn",[f])});$(v).find(".categoryList li").click(function(f){f.stopPropagation();c=$(this).attr("searchData");g();t("category",$(this));g();$(v).find(".category_box").slideUp()});$(v).find(".clearHistoryBtn").click(function(){p()});$(v).find(".clearHistoryBtn").bind("touchstart",function(){event.stopPropagation();p()});$(v).find(".searchInput").bind("touchstart",function(f){f.stopPropagation()});$(v).find(".searchInput").focus(function(a){$(this).val()||setTimeout(function(){f()},200);$(v).find(".category_box").slideUp();w("searchFocus",[a])});$(v).find(".slideupHistoryBtn").bind("touchstart",function(f){f.stopPropagation();f.preventDefault();$(v).find(".searchInput").blur()});$(v).find(".searchInput").blur(function(f){setTimeout(function(){$(v).find(".searchHistoryBox").hide()},200)});$(v).find(".searchBtn").bind("touchstart",function(f){f.stopPropagation();w("searchBtn",[f]);c=$(v).find(".searchInput").val().trim();G()});$(v).find(".resultListBox").bind("mousewheel",function(){event.stopPropagation()});$(v).find(".resultListBox").bind("touchstart",function(){event.stopPropagation()});$(v).find(".resultListBox").bind("touchmove",function(){event.stopPropagation()});$(v).find(".resultListBox").bind("touchend",function(){event.stopPropagation()});$(v).find(".resultListBox ul").scroll(function(f){event.stopPropagation();f=$(this).height();this.scrollHeight==f+this.scrollTop&&(this.bottomAlert||$(this).append(this.bottomAlert),u++,b=!1,u<=x&&G())})},showBackBtn:function(){$(this.html).find(".rtmap_search_box").addClass("result")},hideBackBtn:function(){$(this.html).find(".rtmap_search_box").removeClass("result")},getCategoryList:function(){var f=[];$(this.html).find(".categoryList li").each(function(){var a=$(this).attr("searchData");f.push(a)});return f},onAdd:function(){var f=L.DomUtil.create("div","");f.innerHTML='\x3cdiv class\x3d"rtmap_search_box"\x3e\x3cdiv class\x3d"back"\x3e\x3ci class\x3d"fa fa-chevron-left"\x3e\x3c/i\x3e\x3c/div\x3e\x3cdiv class\x3d"input_box"\x3e\x3cinput type\x3d"text" class\x3d"rtmap_search_input searchInput"/\x3e\x3ci class\x3d"fa fa-close clear_input_btn clearInput"\x3e\x3c/i\x3e\x3cdiv class\x3d"search_history_box searchHistoryBox"\x3e\x3cdiv class\x3d"history_btn_bar"\x3e\x3cdiv class\x3d"slideup_history slideupHistoryBtn"\x3e\x3ci class\x3d"fa fa-angle-up"\x3e\x3c/i\x3e\x3c/div\x3e\x3cdiv class\x3d"clear_history_btn clearHistoryBtn"\x3e\u6e05\u7a7a\u5386\u53f2\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3ci class\x3d"fa fa-th-list search_category categoryBtn"\x3e\x3c/i\x3e\x3cdiv class\x3d"category_box" style\x3d"display: none;"\x3e\x3cul class\x3d"categoryList"\x3e\x3cli class\x3d"wc" searchData\x3d"1901%"\x3e\u536b\u751f\u95f4\x3c/li\x3e\x3cli class\x3d"doorway" searchData\x3d"190206"\x3e\u51fa\u5165\u53e3\x3c/li\x3e\x3cli class\x3d"elevator" searchData\x3d"190201"\x3e\u76f4\u68af\x3c/li\x3e\x3cli class\x3d"ladder" searchData\x3d"190202"\x3e\u6276\u68af\x3c/li\x3e\x3cli class\x3d"information_desk" searchData\x3d"190401_190402"\x3e\u95ee\u8baf\x3c/li\x3e\x3cli class\x3d"restaurant" searchData\x3d"10%"\x3e\u9910\u996e\x3c/li\x3e\x3cli class\x3d"business" searchData\x3d"11%_12%_13%_14%_15%_16%"\x3e\u5546\u4e1a\x3c/li\x3e\x3cli class\x3d"power" searchData\x3d"190303"\x3e\u5145\u7535\u8bbe\u5907\x3c/li\x3e\x3c/ul\x3e\x3c/div\x3e\x3cdiv class\x3d"resultListBox"\x3e\x3cul\x3e\x3c/ul\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"yellow_notice"\x3e\x3c/div\x3e';this.html=f;this.bindEvent();return f}}),C={};return{render:function(){var f=Rtmap.Scene.getMap();t=new B;f.addControl(t)},on:function(f,a){C[f]||(C[f]=[]);C[f].push(a)},clearResultList:g,hideCategory:function(){$(t.html).find(".category_box").slideUp()},clearSearchResult:r,getCurrentSearchPoi:function(){return z}}}(),d=function(){var b=null;return{render:function(){b=L.Control.extend({openstatus:!1,_bindEvent:function(){function b(){var a=c.listScroll[0].scrollTop,r=c.listScroll[0].scrollHeight;offsetHeight=c.listScroll[0].offsetHeight;realyHeight=r-offsetHeight;a==realyHeight?($(".topAngle .fa").removeClass("disable"),$(".bottomAngle .fa").addClass("disable"),0==a&&0==realyHeight&&($(".topAngle .fa").addClass("disable"),$(".bottomAngle .fa").addClass("disable"))):(0==a?$(".topAngle .fa").addClass("disable"):$(".topAngle .fa").removeClass("disable"),$(".bottomAngle .fa").removeClass("disable"))}var c=this;this.listScroll.bind("mousewheel",function(){event.stopPropagation()});this.listScroll.scroll(function(){b()});this.listScroll.bind("touchstart",function(){event.stopPropagation()});this.listScroll.bind("touchmove",function(a){a.stopPropagation()});this.listScroll.bind("touchend",function(){event.stopPropagation()});this.floorBtn.click(function(a){a.stopPropagation();a.preventDefault();c.openstatus=!c.openstatus;c.changeList.slideToggle(300);if(c.openstatus){var p=function(){k+=d;c.listScroll[0].scrollTop=k;Math.abs(k-h)<=Math.abs(d)?(c.listScroll[0].scrollTop=h,b()):(b(),requestAnimationFrame(p))},h=c.listScroll.find("li.active")[0].offsetTop-80;a=c.listScroll[0].scrollTop;var d=(h-a)/30,k=a;p()}});Rtmap.Scene.on("changeFloor",function(b){var r=a.Config.getFloorAliasName(b);0<r.indexOf(".")&&(r=r.replace("B",""),r=r.replace("F",""),r=Math.round(parseFloat(r)),r=b.substring(0,1)+(r.toString()+"M"));c.floorBtn.text(r.toUpperCase());c.listScroll.find("li.active").removeClass("active");c.listScroll.find("li."+r.toLowerCase()).addClass("active");c.changeList.slideUp();c.openstatus=!1});Rtmap.Scene.on("mapAction",function(){"follow"!=window.locationModel&&(c.changeList.slideUp(),c.openstatus=!1)})},setData:function(b){function c(a,b){a.click(function(a){window.locationModel="free";Rtmap.Control.disableLocal();a.stopPropagation();a=Rtmap.Scene.getNowFloor();b!=a&&Rtmap.Scene.changeFloorTo(b)})}var m=this.listScroll.find(".floor_list");m.html("");this.dataLength=b.length;for(var p=0;p<b.length;p++){var h=b[p].floor.toLocaleLowerCase(),d=a.Config.getFloorAliasName(h);0<d.indexOf(".")&&(d=d.replace("B",""),d=d.replace("F",""),d=Math.round(parseFloat(d)),d=h.substring(0,1)+(d.toString()+"M"));var d=$("\x3cli/\x3e",{text:d.toUpperCase(),class:d.toLowerCase()}),k=Rtmap.Scene.getNowFloor();h==k&&d.addClass("active");c(d,h);m.append(d)}},options:{},onAdd:function(){var a=L.DomUtil.create("div","");a.innerHTML='\x3cdiv class\x3d"floor_change_box"\x3e\x3cdiv class\x3d"rtmap_floor_change_list"\x3e\x3cdiv class\x3d"top_angle topAngle"\x3e\x3ci class\x3d"fa fa-angle-up"\x3e\x3c/i\x3e\x3c/div\x3e\x3cdiv class\x3d"list_scroll"\x3e\x3cul class\x3d"floor_list"\x3e\x3c/ul\x3e\x3c/div\x3e\x3cdiv class\x3d"bottom_angle bottomAngle"\x3e\x3ci class\x3d"fa fa-angle-down"\x3e\x3c/i\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"rtmap_floor_btn"\x3e\x3ci class\x3d"fa fa-spinner fa-spin"\x3e\x3c/i\x3e\x3c/div\x3e\x3c/div\x3e';var b=$(a).find(".list_scroll");this.floorBtn=$(a).find(".rtmap_floor_btn");this.listScroll=b;this.changeList=$(a).find(".rtmap_floor_change_list");this._bindEvent();$(a).parent().addClass("flo");return a}});var c=new b({position:"bottomleft"});Rtmap.Scene.getMap().addControl(c);return c}}}();return{showScale:function(){var a=L.control.scale({position:"bottomleft",imperial:!1,className:"fa"});Rtmap.Scene.getMap().addControl(a);a=a.getContainer();a=$(a);a.addClass("rtmap_scale");a.parent().addClass("rtmap_scale_box")},showZoom:function(){var a=L.control.zoom({position:"bottomright",zoomInText:"+",zoomOutText:"-"});Rtmap.Scene.getMap().addControl(a);a=a.getContainer();a=$(a);a.addClass("rtmap_zoom");a.parent().addClass("rtmap_zoom_box");var a=$(".leaflet-control-zoom-out"),b=$(".leaflet-control-zoom-in");a.bind("touchstart",function(a){-1<$(this).attr("class").indexOf("leaflet-disabled")&&(a.preventDefault(),a.stopPropagation())});b.bind("touchstart",function(a){-1<$(this).attr("class").indexOf("leaflet-disabled")&&(a.preventDefault(),a.stopPropagation())})},showLocal:function(a){var b=new (L.Control.extend({_enable:!0,setEnable:function(a){this._enable!=a&&(this._enable=a,a=$(this._container),this._enable?a.css({background:"rgba(255,255,255,0) url(public/img/control.png) center center no-repeat","background-size":"cover"}):a.css({background:"rgba(255,255,255,0) url(public/img/control_disable.png) center center no-repeat","background-size":"cover"}))},options:{},onAdd:function(){var b=L.DomUtil.create("i","fa fa-crosshairs");$(b).click(function(){a();var b=$(this);b.css({"pointer-events":"none"});setTimeout(function(){b.css({"pointer-events":"auto"})},2E3)});$(b).dblclick(function(){return!1});$(b).addClass("rtmap_local");return this.html=b}}))({position:"bottomright"});Rtmap.Scene.getMap().addControl(b);h=b},disableLocal:function(){h?h.setEnable(!1):""},enableLocal:function(){h?h.setEnable(!0):""},showSearch:function(){y.render();return y},showFloorChange:function(){return d.render()}}}();a.PoiLabelFactory=function(){function q(){A=a.Scene.getMap();var b=A.options.maxZoom-A.options.minZoom,c=Math.round(A._zoom)-A.options.minZoom;d=Math.pow(2,c);y=.2>=c/b?1.6:.4>=c/b?1.5:.6>=c/b?1.4:.8>=c/b?1.2:1}function l(a,b){b||(b=1);var c=a.getCenterPoint()||{},d=a.getSize()||{};return{x:c.x,y:c.y,height:d.height*b,width:d.width*b}}function k(a,b){return Math.abs(b.x-a.x)<a.width/2+b.width/2&&Math.abs(b.y-a.y)<a.height/2+b.height/2?!0:!1}function e(a,c){for(var g=0;g<h[a].length;g++)if(h[a][g]==b[i]){h[a].splice(g,1);break}}var b=[],c=null,h={},y,d,A;return{getLabelLayers:function(){return b},getLabelByPoiNum:function(a){for(var c=b.length;c--;)if(b[c].poiNum==a)return b[c]},getLabelGroupLayer:function(){return c},getLabelCache:function(){return h},setLableEnvirement:function(a,d,g){h=a;b=d;c=g},eachLabel:function(a){for(var c=0;c<b.length;c++)a(b[c])},removeLabelCache:function(a,b){var c=h[b];if(c)for(var d=0;d<c.length;d++)a==c[d]&&c.splice(d,1)},clearAll:function(){a.Scene.removeLayers(b);b=[];h={}},allLabelsHidden:!1,hideLabel:function(a,c,g){for(c=0;c<b.length;c++)if(b[c].poiNum==a){b[c].iconLabelHide();break}},hideAllLabels:function(){a.Scene.hideLayers(b);allLabelsHidden=!0},prettyShow:function(){var c=a.Scene.getMap();if(a.Config.getOption().largeScene&&"cdn"==a.Config.getOption().loadModel&&(a.Scene.filterLayersByZoom(),0==b.length||parseInt(a.Scene.getMap()._zoom)<=c.options.minZoom))return;var d;A=a.Scene.getMap();d=A._zoom>A.options.minZoom+2?!0:!1;q();var c=c.getBounds().pad(.1),g=Math.round(a.Scene.getMap()._zoom);if(h[g])for(var m=h[g],n=0;n<m.length;n++){var e=m[n];a.Config.getOption().largeScene&&e.filterByZoom(g);e.show=!0;e._labelHideStatus?($(e._container).addClass("hide"),e.show=!1):d&&!c.contains(e._latlng)?($(e._container).addClass("hide"),e.show=!1):$(e._container).removeClass("hide")}else{h[g]=[];for(n=0;n<b.length;n++)if(e=b[n],a.Config.getOption().largeScene&&e.filterByZoom(g),e._labelHideStatus)$(e._container).addClass("hide"),e.show=!1;else if(m=e.OL_Array){for(var w=!1,t=0;t<m.length;t++){var u=m[t];if(u!=e&&k(l(e,y),l(u,y))&&u.show){if(e.haveIcon&&!u.haveIcon||e.getZoomVisble(g-1))$(u._container).addClass("hide"),u.show=!1,this.removeLabelCache(u,g);if(!e.haveIcon&&u.haveIcon||!e.getZoomVisble(g-1)){w=!0;break}}}w?($(e._container).addClass("hide"),e.show=!1):(h[g].push(e),e.setZoomVisble(g,!0),$(e._container).removeClass("hide"),e.show=!0)}else h[g].push(e),$(e._container).removeClass("hide"),e.show=!0;if(d)for(d=0;d<h[g].length;d++)n=h[g][d],c.contains(n._latlng)||($(n._container).addClass("hide"),n.show=!1);delete h[g]}allLabelsHidden=!1},addLabel:function(p,r){var g=new D(p.latlng,p.name,{},p.type);g.poiNum=p.poiNum;g.two_class=p.two_class;g.class_extension=p.class_extension;g.layer=p.layer;b.push(g);null==c&&(c=L.layerGroup(),a.Scene.addLayer(c));c.addLayer(g);g._nowLayer=r;g.setDisplayStyle();g.show=!0;q();for(var m=!0,n=0;n<b.length;n++)g!=b[n]&&k(l(b[n],d),l(g,d))&&(g.OL_Array?"":g.OL_Array=[],g.OL_Array.push(b[n]),b[n].minZoomVisble&&(!g.haveIcon||b[n].haveIcon||g._labelHideStatus?m=!1:e(A.options.minZoom,b[n])),k(l(b[n],y),l(g,y))&&b[n].show&&(!g.haveIcon||b[n].haveIcon||g._labelHideStatus?($(g._container).addClass("hide"),g.show=!1):(e(A.options.minZoom,b[n]),$(b[n]._container).addClass("hide"),b[n].show=!1)));a.Config.getOption().largeScene&&(g._labelHideStatus||Math.round(A._zoom)==A.options.minZoom)&&($(g._container).addClass("hide"),g.show=!1);m?(h[A.options.minZoom]||(h[A.options.minZoom]=[]),h[A.options.minZoom].push(g),g.setZoomVisble(A.options.minZoom,!0),g.minZoomVisble=!0):(g.minZoomVisble=!1,g.setZoomVisble(A.options.minZoom,!1));g.show&&(h[A._zoom]||(h[A._zoom]=[]),h[A._zoom].push(g),g.setZoomVisble(A._zoom,!0));return g},addExistLabel:function(a){b.push(a)},resetIconStatus:function(){for(var a=0;a<b.length;a++)b[a].iconLabelShow()}}}();a.Scene=function(){function q(){if(!d)throw Error("you need create Map first!");}function l(a){a=a.features;for(var b=[],c=[],d=0;d<a.length;d++){var g=a[d];if("MultiPolygon"==g.geometry.type)for(var h=g.geometry.coordinates[0][0],m=0;m<h.length;m++)b.push(h[m][0]),c.push(h[m][1]);else for(var e=0;e<g.geometry.coordinates[0].length;e++)for(h=g.geometry.coordinates[0][e],m=0;m<h.length;m++)b.push(h[0]),c.push(h[1])}b.sort(function(a,f){return parseFloat(a)-parseFloat(f)});c.sort(function(a,f){return parseFloat(a)-parseFloat(f)});return{left:b[0],right:b[b.length-1],bottom:c[0],top:c[c.length-1],centerX:(b[0]+b[b.length-1])/2,centerY:(c[0]+c[c.length-1])/2}}function k(f,b,c){B=f;if(x[f]){p=x[f].poi_layer;r=x[f].poi_layer_childs;m=x[f].bk_layer;n=x[f].fn_layer;g=x[f].typedata_layers;m?Rtmap.Scene.addLayer(m):"";m?m.hide=!1:"";n?Rtmap.Scene.addLayer(n):"";n?n.hide=!1:"";for(var d in g)g[d].addToMap&&(Rtmap.Scene.addLayer(g[d]),g[d].hide=!1);p?Rtmap.Scene.addLayer(p):"";p?p.hide=!1:"";Rtmap.Scene.filterLayersByZoom();Rtmap.PoiLabelFactory.setLableEnvirement(x[f].labelCache,x[f].labelLayers,x[f].labelGrouplayer);for(d=0;d<x[f].labelLayers.length;d++)x[f].labelLayers[d]&&(Rtmap.Scene.addLayer(x[f].labelLayers[d]),x[f].labelLayers[d].setDisplayStyle());Rtmap.PoiLabelFactory.hideAllLabels();Rtmap.PoiLabelFactory.prettyShow();b?b():"";u._call("drawedMap",[f,c])}else if("cdn"==C){var h,k,v,I,A;Rtmap.DataProvider.getBKCDN({floor:f},function(d){h=d;w?"":w=l(d);E&&y()&&(E=!1);Rtmap.Scene.createBK(h);Rtmap.DataProvider.getFNCDN({floor:f},function(d){k=d;Rtmap.Scene.createFN(k);Rtmap.DataProvider.getPoiCDN({floor:f},function(d){v=d;Rtmap.Scene.createPoi(v);Rtmap.DataProvider.getTypeDataCDN({floor:f},"infrastructure",function(d){I=d;Rtmap.Scene.createTypeData(I,"infrastructure");Rtmap.DataProvider.getTypeDataCDN({floor:f},"traffic",function(d){A=d;Rtmap.Scene.createTypeData(A,"traffic",!0);b?b():"";x[f]={layers:g,bk_layer:m,fn_layer:n,poi_layer:p,poi_layer_childs:r,typedata_layers:g,labelCache:a.PoiLabelFactory.getLabelCache(),labelLayers:a.PoiLabelFactory.getLabelLayers(),labelGrouplayer:a.PoiLabelFactory.getLabelGroupLayer()};u._call("drawedMap",[f,c])})})})})},function(){C="server";e(f,b)})}else e(f,b);a.Config.setup({loadModel:C})}function e(a,b){var c,d,g;Rtmap.DataProvider.getBK({floor:a},function(h){c=h;w=l(h);E&&y()&&(E=!1);Rtmap.DataProvider.getFN({floor:a},function(h){d=h;Rtmap.DataProvider.getPoi({floor:a},function(h){g=h;Rtmap.Scene.createBK(c);Rtmap.Scene.createFN(d);Rtmap.Scene.createPoi(g,!0);u._call("drawedMap",[a]);b?b():""})})})}function b(){d.on("move",function(a,b,c){u._call("mapAction")});d.on("click",function(a){u._call("mapAction");u._call("mapClick");if(z){var b=h(a.latlng);u._call("poiClick",[a,b])}});d.on("drag",function(a,b,c){u._call("mapAction");u._call("mapDrag");return!1});d.on("dragend",function(f,b){var c=d.getCenter(),g=a.Scene.getBuildBounds(),c=L.CRS.EPSG3395.projection.project(c),h=c.x,m=c.y,e=!1;c.x<g.left?(h=g.left,e=!0):c.x>g.right&&(h=g.right,e=!0);c.y>g.top?(m=g.top,e=!0):c.y<g.bottom&&(m=g.bottom,e=!0);e&&a.Scene.moveTo({x:h,y:m})});d.on("zoomstart",function(){a.PoiLabelFactory.hideAllLabels();window.clearTimeout(window.zoomLabelRefreshTimer)});window.zoomLabelRefresh=function(){a.PoiLabelFactory.prettyShow();window.clearTimeout(window.zoomLabelRefreshTimer)};window.dragLabelRefresh=function(){map=a.Scene.getMap();var f=parseInt((map.options.maxZoom-map.options.minZoom)/2);map.options.maxZoom-parseInt(map._zoom)<=f&&a.PoiLabelFactory.prettyShow()};d.on("zoomend",function(){});d.on("dragstart",function(){});d.on("dragend",function(){a.PoiLabelFactory.prettyShow()});d.on("moveend",function(){a.PoiLabelFactory.prettyShow()});debugTools&&$("#show").show()}function c(a,b){u[a]||(u[a]=[]);u[a].push(b)}function h(a){for(var b=Rtmap.PoiLabelFactory.getLabelLayers(),c=0;c<b.length;c++){var d=b[c];if(d._nowLayer._latlng&&d.show&&d.getBounds().contains(a))return d._nowLayer}}function y(f){if(f)return d.fitBounds(f.getBounds().pad(.5)),!0;d.options.minZoom=17;f=!1;if(w.left&&w.top){var b=new L.Point(w.left,w.top),c=new L.Point(w.right,w.bottom);if(500<Math.abs(w.right-w.left)||500<Math.abs(w.top-w.bottom))f=!0;b=L.CRS.EPSG3395.projection.unproject(b);c=L.CRS.EPSG3395.projection.unproject(c);c=L.polyline([b,c]);b=d.getBoundsZoom(c.getBounds(),!1);f?(d.fitBounds(c.getBounds()),d.options.minZoom=b-1,Rtmap.Scene.minZoom=b-1):(d.fitBounds(c.getBounds()),d._zoom=b,d.options.minZoom=b,Rtmap.Scene.minZoom=b);a.Config.setup({largeScene:f});return!0}return!1}var d=null,A=null,p=null,r={},g={},m=null,n=null,B=null,w=null,t={},u={_call:function(a,b){var c=this[a];if(c)for(var d=0;d<c.length;d++)c[d].apply(this,b)},changeFloor:[],BKClick:[],poiClick:[]},x={},z=!0,E=!0,C="cdn";c("changeFloor",function(a){if(t[a])for(var b=0;b<t[a].length;b++)d.addLayer(t[a][b])});return{clearAll:function(){a.PoiLabelFactory.clearAll();p?d.removeLayer(p):"";m?d.removeLayer(m):"";n?d.removeLayer(n):"";for(var b in t)if(0<t[b].length)for(var c=0;c<t[b].length;c++)d.removeLayer(t[b][c]);for(var h in g)d.removeLayer(g[h]);g={};n=m=p=null},on:c,getNowFloor:function(){return B},getPoiByNum:function(a,b){for(var c in g)for(var d=g[c].getLayers(),h=0;h<d.length;h++)if(d[h].poiNo==b)return d[h]},getPoiByName:function(a,b){for(var c in g)for(var d=g[c].getLayers(),h=0;h<d.length;h++)if(d[h].feature.properties.name_chinese==b||d[h].feature.properties.store_id==b)return d[h]},changeFloorTo:function(b,c,d){a.Scene.clearAll();b=b.toLowerCase();k(b,d,c);u._call("changeFloor",arguments)},initMapContext:function(a,c){if(!d){var g=a||{};g.crs=g.crs||L.CRS.EPSG3395;g.center=g.center||[-50,115];g.zoom=g.zoom||1;g.zoomControl=g.zoomControl||!1;var h=L.CRS.EPSG3395.projection.unproject(new L.Point(115,-35)),m=1,e=!1,k=!1;Rtmap.Scene.maxZoom=22;-1!=navigator.userAgent.indexOf("iPhone")?(k=!1,e=!0,m=1):(k=!0,e=!1,m=.2);var r=L.svg();r.options.padding=m;d=new L.Map(g.parentDOM,{crs:L.CRS.EPSG3395,center:h,zoom:16,minZoom:16,maxZoom:22,zoomControl:!1,attributionControl:!1,bounceAtZoomLimits:!1,doubleClickZoom:!1,inertia:e,noMoveStart:k,renderer:r,zoomDelta:.2,zoomSnap:0});d._drawMoreRatio=m;b();A=$("#"+g.parentDOM);return this}},panBy:function(a){d.panBy(a)},createMarker:function(b){var c;if(b.Lat&&b.Lng)c=new L.Point(b.Lat,b.Lng);else if(b.x&&b.y)c=L.CRS.EPSG3395.projection.unproject(new L.Point(b.x,b.y));else return!1;if("circle"==b.type)b.color=b.color||"#1e6ac0",b.fillColor=b.fillColor||"#1e6ac0",c=L.circleMarker(c,b).addTo(d);else{var g=a.Style.getGlobalConfig("normal_icon_url"),g=L.icon({iconUrl:g,iconRetinaUrl:g,iconSize:[30,30],iconAnchor:[15,30],shadowSize:[68,95],shadowAnchor:[22,94]});b.icon=b.icon||g;c=L.marker(c,b).addTo(d)}b.floor=b.floor||Rtmap.Scene.getNowFloor().toLowerCase();t[b.floor]||(t[b.floor]=[]);t[b.floor].push(c);return c},addExistMarker:function(a,b){t[b]||(t[b]=[]);t[b].push(a)},createLine:function(a,b){var c=[];if(a.PointA.Lat&&a.PointA.Lng){var g=new L.Point(a.pointA.Lat,a.pointA.Lng),h=new L.Point(a.pointB.Lat,a.pointB.Lng);c.push(g,h)}else if(a.PointA.x&&a.PointA.y)g=L.CRS.EPSG3395.projection.unproject(new L.Point(a.PointA.x,a.PointA.y)),h=L.CRS.EPSG3395.projection.unproject(new L.Point(a.PointB.x,a.PointB.y)),c.push(g,h);else return!1;c=L.polyline(c,{color:"red"}).addTo(d);t[a.floor]||(t[a.floor]=[]);t[a.floor].push(c);return c},eachPoiNameLayer:function(b){a.PoiLabelFactory.eachLabel(b)},getMap:function(){return d},setSceneModel:function(a,b){"flying"==a&&(Rtmap.Scene.ScenceModel=a);"parking"==a&&(Rtmap.Scene.moveTo({x:608,y:-402},Rtmap.Scene.getMap().zoom),Rtmap.Scene.changeFloorTo("f1"));Rtmap.Scene.ScenceModel=a;b()},setAllowPoiClick:function(a){z=a},fitBounds:y,getParentDOM:function(){return A},getBuildBounds:function(){return w},getCenter:function(){return{x:w.centerX,y:w.centerY}},moveToCenter:function(a){var b=this.getCenter(),b=L.CRS.EPSG3395.projection.unproject(new L.Point(b.x,b.y));d.setView(b,a)},moveTo:function(a,b){var c;if("undefined"!=typeof a.Lat&&"undefined"!=typeof a.Lng)c=new L.Point(a.Lat,a.Lng);else if("undefined"!=typeof a.x&&"undefined"!=typeof a.y)c=L.CRS.EPSG3395.projection.unproject(new L.Point(a.x,a.y));else return!1;d.setView(c,b)},setZoom:function(a){d.setZoom(a)},addLayer:function(a){d.addLayer(a)},getLayer:function(){return p},getFNLayer:function(){return n},getBKLayer:function(){return m},getTypeDataLayer:function(){return g},removeMarker:function(a){a.animate?a.animate.stop():"";a?d.removeLayer(a):""},removeLayer:function(a,b){if(b)for(var c in t)if(0<t[c].length)for(var g=0;g<t[c].length;g++)t[c][g]==a&&t[c].splice(g,1);a?d.removeLayer(a):""},removeLayers:function(a){for(var b=0;b<a.length;b++)a[b]?d.removeLayer(a[b]):""},hideLayers:function(a){for(var b=0;b<a.length;b++)a[b].show&&($(a[b]._container).addClass("hide"),a[b].show=!1)},showLayers:function(a){for(var b=a.length,c=0;c<b;c++)a[c].show||($(a[c]._container).removeClass("hide"),a[c].show=!0)},createFN:function(b){q();n=L.geoJson(b,{style:{},filter:function(a,b){return 20<a.properties.style?!1:!0},coordsToLatLng:function(a){a=L.point(a[0],a[1]);return L.CRS.EPSG3395.projection.unproject(a)},onEachFeature:function(b,c){c.setStyle(a.Style.getStyleByPoiType(b.properties.style))}}).addTo(d);n.on("click",function(a){if(z){var b=h(a.latlng);u._call("poiClick",[a,b]);L.DomEvent.stopPropagation(a)}})},createBK:function(b){q();m=L.geoJson(b,{style:{},coordsToLatLng:function(a){a=L.point(a[0],a[1]);return L.CRS.EPSG3395.projection.unproject(a)},onEachFeature:function(b,c){c.setStyle(a.Style.getStyleByPoiType(b.properties.style))}}).addTo(d);m.on("click",function(a){if(z){u._call("BKClick",[a]);var b=h(a.latlng);u._call("poiClick",[a,b]);L.DomEvent.stopPropagation(a)}})},createPoi:function(b,c){function h(a,b){b.on({click:function(a){z&&(u._call("poiClick",[a,b]),L.DomEvent.stopPropagation(a))}})}q();if(!b)throw Error("createPoi function need arguments!");for(var m=0,e=0;e<b.features.length;e++)b.features[e].geometry||m++;p=L.geoJson(b,{crs:L.CRS.EPSG3395,style:{},coordsToLatLng:function(a){a=L.point(a[0],a[1]);return L.CRS.EPSG3395.projection.unproject(a)},onEachFeature:function(b,c){var f=b.properties.name_chinese,d=b.properties.style,g=b.properties.poi_no;if(f&&""!=f){var m=L.point(b.properties.x_coord,b.properties.y_coord),m=L.CRS.EPSG3395.projection.unproject(m);a.PoiLabelFactory.addLabel({latlng:m,name:f,type:d,poiNum:g,two_class:b.properties.two_class,layer:c,class_extension:b.properties.class_extension},c)}c.setStyle(Rtmap.Classification.getLayerStyle(c));c.poiNo=g;h(b,c)}});g.POI=p;p.hide=!0;c&&(p.addTo(d),p.hide=!1);Page.capturemode&&Rtmap.FeatureSelect.initCenterPoint()},createTypeData:function(b,c,h){function m(a,b){b.on({click:function(a){z&&(u._call("poiClick",[a,b]),L.DomEvent.stopPropagation(a))}})}q();if(!b)throw Error("createTypeData function need arguments!");for(var e=0,k=0;k<b.features.length;k++)b.features[k].geometry||e++;b=L.geoJson(b,{crs:L.CRS.EPSG3395,style:{},coordsToLatLng:function(a){a=L.point(a[0],a[1]);return L.CRS.EPSG3395.projection.unproject(a)},onEachFeature:function(b,f){var d=b.properties.name_chinese,g=b.properties.style,e=b.properties.poi_no;r[b.properties.floor]||(r[b.properties.floor]={});r[b.properties.floor][e]=f._leaflet_id;if(d&&""!=d){var k=L.point(b.properties.x_coord,b.properties.y_coord),k=L.CRS.EPSG3395.projection.unproject(k);a.PoiLabelFactory.addLabel({latlng:k,name:d,type:g,poiNum:e,two_class:b.properties.two_class,layer:f,class_extension:b.properties.class_extension},f)}d=b.properties.style;f.setStyle&&(Rtmap.Classification.travelpoi.isTravelPoi(b.properties.two_class)?f.setStyle({type:5,fillColor:"#e8c377",color:"#af7d0c",weight:.5,opacity:1,fillOpacity:1,hover:{fillColor:"#dddddd",color:"#e9bbba",weight:.5,opacity:1,fillOpacity:1}}):Rtmap.Classification.airportpoi.isAirportpoi(b.properties.two_class)?f.setStyle({type:5,fillColor:"#d0dee2",color:"#8eadc1",weight:.5,opacity:1,fillOpacity:1,hover:{fillColor:"#dddddd",color:"#e9bbba",weight:.5,opacity:1,fillOpacity:1}}):f.setStyle(a.Style.getStyleByPoiType(d)));h&&m(b,f);f.poiNo=e;f.dataType=c}});h&&(b.addTo(d),b.addToMap=!0);return g[c]=b},filterLayersByZoom:function(){map=a.Scene.getMap();var b=a.Scene.getFNLayer();16.2>map._zoom?b&&!b.hide&&(map.removeLayer(b),b.hide=!0):(b&&b.hide&&(map.addLayer(b),b.hide=!1),Rtmap.TrackFactory.resetTrackLine());17.2>=map._zoom?(b=a.Scene.getTypeDataLayer(),b.POI&&!b.POI.hide&&(map.removeLayer(b.POI),b.POI.hide=!0),b.traffic&&!b.traffic.hide&&(map.removeLayer(b.traffic),b.traffic.hide=!0),Rtmap.TrackFactory.resetTrackLine()):17.2<map._zoom&&(b=a.Scene.getTypeDataLayer(),b.POI&&b.POI.hide&&(map.addLayer(b.POI),b.POI.hide=!1),b.traffic&&b.traffic.hide&&(map.addLayer(b.traffic),b.traffic.hide=!1),Rtmap.TrackFactory.resetTrackLine())}}}();a.Style=function(){var a={canvas_color:"#fcffd5",focus_icon_url:"./public/img/red.png",font_color:"#000000",normal_icon_url:"./public/img/blue.png",start_icon_url:"./public/img/start.png",end_icon_url:"./public/img/end.png",wc_icon_url:"./public/img/wc.png",atm_icon_url:"./public/img/atm.png",cashier_desk_icon_url:"./public/img/cashier_desk.png",information_desk_icon_url:"./public/img/information_desk.png",elevator_icon_url:"./public/img/elevator.png",ladder_icon_url:"./public/img/escalator.png",stairway_icon_url:"./public/img/stairway.png",doorway_icon_url:"./public/img/doorway.png",restaurant_icon_url:"./public/img/restaurant.png",business_icon_url:"./public/img/supermarket.png",power_icon_url:"./public/img/supermarket.png",wc_red_icon_url:"./public/img/wc.png",atm_red_icon_url:"./public/img/atm.png",cashier_desk_red_icon_url:"./public/img/cashier_desk.png",information_desk_red_icon_url:"./public/img/information_desk.png",elevator_red_icon_url:"./public/img/elevator.png",ladder_red_icon_url:"./public/img/escalator.png",stairway_red_icon_url:"./public/img/stairway.png",doorway_red_icon_url:"./public/img/doorway.png"},l={},k={3:{fillColor:"#efefef",color:"#333",weight:3,opacity:1,fillOpacity:1},4:{fillColor:"#d5ebab",color:"#9bceb2",weight:1,opacity:1,fillOpacity:1},5:{fillColor:"#fdc8c4",color:"#f4c3b4",weight:1,opacity:1,fillOpacity:1,hover:{fillColor:"#ffb1ac",color:"#f4c3b4",weight:1,opacity:1}},6:{fillColor:"#ffeda0",color:"#ffeda0",weight:1,opacity:1,fillOpacity:1},7:{fillColor:"#d5b9e9",color:"#678d88",weight:1,opacity:1,fillOpacity:1},8:{fillColor:"#ddd",color:"#999",weight:1,opacity:1,fillOpacity:1},12:{fillColor:"#ffeda0",color:"#ffeda0",weight:1,opacity:1,fillOpacity:1}},e={free:{type:20,fillColor:"#A9A9F0",color:"#6e6e6e",weight:.5,opacity:1,fillOpacity:1},busy:{type:20,fillColor:"#E97F7F",color:"#6e6e6e",weight:.5,opacity:1,fillOpacity:1},plan:{type:20,fillColor:"#5B65E8",color:"#6e6e6e",weight:.5,opacity:1,fillOpacity:1}};return{getStyleByPoiType:function(a){return k[a]},setPoiDefaultStyle:function(a,c){k[a]?"":k[a]={};for(var h in c)k[a][h]=c[h]},setGlobalConfig:function(b){for(var c in b)b[c]?a[c]=b[c]:""},getGlobalConfig:function(b){return a[b]},setImageConfig:function(a){for(var c in a)a[c]?l[c]=a[c]:""},getImageConfig:function(a){return l[a]},getParkingStatusStyle:function(){return e}}}();a.DataProvider=function(){function q(a,h){if(b[a])for(var e=0;e<b[a].length;e++)b[a][e].apply(this,h)}function l(b,h){var k={},d=a.Config.getOption();k.key=d.Key;var l=a.Config.getOption().Token;l?k.access_token=l:"";k.buildid=d.buildId;k.floor=b.floor||d.defaultFloor;k.maptype=b.type;k.codeType=2;var p=(new Date).getTime();e[b.type]&&e[b.type][b.floor]?h(e[b.type][b.floor]):(q("beforeGetPoi",[p]),$.ajax({timeout:6E4,type:"POST",url:"http://lbsapi.rtmap.com/rtmap_lbs_api/v1/rtmap/floor_geojson",data:JSON.stringify(k),dataType:"text"}).done(function(a){if(k.floor==Rtmap.Scene.getNowFloor()){a:{var d=a.length,m=a[0].charCodeAt(0),d=(d-24)%m;0==d?d+=1:"";var m=a.substr(d+1,24),l;try{l=atob(m)}catch(p){a={type:"FeatureCollection",features:[],totalFeatures:0};break a}Rtmap.Config.setup({buildId:l});d=Rtmap.Config.getOption().buildId;a=a.replace(new RegExp(m),"");for(l=m=0;l<d.length;l++)m+=parseInt(d[l]);d=m%10+10;m="";for(l=0;l<a.length;l++)var A=l%d^a[l].charCodeAt(0),m=m+String.fromCharCode(A);try{var q=JSON.parse(m)}catch(u){console.error("")}a=q}a.result&&"0"!=a.result.error_code?alert(a.result.error_msg):(e[b.type]||(e[b.type]={}),e[b.type][b.floor]=a,h(a))}}).error(function(){var a=(new Date).getTime();q("afterGetPoi",[p,a])}).complete(function(a){a=(new Date).getTime();q("afterGetPoi",[p,a])}))}function k(b,h,k){var d,l=a.Config.getOption();a.Config.getOption().Token||"";d=b.floor||l.defaultFloor;var p=(new Date).getTime();e[b.type]&&e[b.type][b.floor]?h(e[b.type][b.floor]):(q("beforeGetPoi",[p]),$.ajax({timeout:6E4,type:"GET",url:"http://res.rtmap.com/map/data3/"+l.buildId+"_"+b.floor+"_"+b.type+".json",dataType:"json"}).done(function(a){d==Rtmap.Scene.getNowFloor()&&(a.result&&"0"!=a.result.error_code?alert(a.result.error_msg):(e[b.type]||(e[b.type]={}),e[b.type][b.floor]=a,h(a)))}).error(function(){var a=(new Date).getTime();q("afterGetPoi",[p,a]);k?k():""}).complete(function(a){a=(new Date).getTime();q("afterGetPoi",[p,a])}))}var e={},b={};return{getBuildInfo:function(b,h){var e={};e.key=a.Config.getOption().Key;var d=a.Config.getOption().Token;d?e.access_token=d:"";e.buildid=b.buildId||a.Config.getOption().buildId;e.map_version=$("#map_version").attr("value");b.length?e.beacons=JSON.stringify(b):"";var k=(new Date).getTime();q("beforGetBuildInfo",[k]);$.ajax({type:"POST",url:"http://lbsapi.rtmap.com/rtmap_lbs_api/v1/rtmap/build_detail",data:JSON.stringify(e),dataType:"json"}).done(function(b){"0"==b.result.error_code?(a.Config.setup({vendorDetailUrl:b.build_detail.url}),a.Config.setup({poiDetialType:b.build_detail.type}),"",h?h(null,b.build_detail):""):(alert(b.result.error_msg),h?h("get Data error"):"")}).complete(function(){q("afterGetBuildInfo",[k])})},on:function(a,h){b[a]||(b[a]=[]);b[a].push(h)},getTypeData:function(a,b,e){k({type:b,floor:a.floor},function(a){e(a)})},getPoi:function(a,b){l({type:"poi",floor:a.floor},function(a){0!=a.features.length&&b(a)})},getFN:function(a,b){l({type:"fn",floor:a.floor},b)},getBK:function(a,b){l({type:"bk",floor:a.floor},b)},getBKCDN:function(a,b,e){k({type:"bk",floor:a.floor},b,e)},getFNCDN:function(a,b){k({type:"basic",floor:a.floor},b)},getPoiCDN:function(a,b){k({type:"shopping",floor:a.floor},function(a){b(a)})},getTypeDataCDN:function(a,b,e){k({type:b,floor:a.floor},function(a){e(a)})},clearCache:function(a,b){e[a]&&e[a][b]&&(e[a][b]={})}}}();a.TrackFactory=function(){function q(b){var c=a.Style.getGlobalConfig("start_icon_url"),d=a.Style.getGlobalConfig("start_icon_url");b&&"car"==b&&(d=c="./public/img/car.png");b=L.icon({iconUrl:c,iconRetinaUrl:d,iconSize:[40,40],iconAnchor:[20,40],shadowSize:[68,95],shadowAnchor:[22,94]});c=new L.Point(m.x_coord,m.y_coord);c=L.CRS.EPSG3395.projection.unproject(c);m.Marker?a.Scene.removeLayer(m.Marker):"";m.Marker=L.marker(c,{icon:b});m.floor==a.Scene.getNowFloor()&&a.Scene.addLayer(m.Marker)}function l(b,c){var d=a.Style.getGlobalConfig("end_icon_url"),f=a.Style.getGlobalConfig("end_icon_url");c&&"car"==c&&(f=d="./public/img/car.png");d=L.icon({iconUrl:d,iconRetinaUrl:f,iconSize:[40,40],iconAnchor:[20,40],shadowSize:[0,0],shadowAnchor:[22,94]});f=new L.Point(n.x_coord,n.y_coord);f=L.CRS.EPSG3395.projection.unproject(f);n.Marker?a.Scene.removeLayer(n.Marker):"";n.Marker=L.marker(f,{icon:d});n.floor==a.Scene.getNowFloor()&&(a.Scene.addLayer(n.Marker),n.Marker.update());Page.wechat.clearLocationTargetLine?Page.wechat.clearLocationTargetLine():""}function k(a,b){if(w[a])for(var c=0;c<w[a].length;c++)w[a][c].apply(this,b)}function e(c){function d(){var b={};b.key=a.Config.getOption().Key;var c=a.Config.getOption().Token;c?b.access_token=c:"";var c=m.x_coord,f=m.y_coord,g=n.x_coord,e=n.y_coord;b.buildid=a.Config.getOption().buildId;b.pointlist=[{floor:m.floor,x:c,y:-f},{floor:n.floor,x:g,y:-e}];B?b.route_pointlist=B:"";return JSON.stringify(b)}if(m.Poi&&n.Poi&&m.Poi!=n.Poi){var g=d();k("beforeRequest");y();$.ajax({timeout:6E3,type:"POST",url:"http://lbsapi.rtmap.com/rtmap_lbs_api/v2/rtmap/navigation",data:g}).done(function(d){if("0"==d.result.error_code){var g=d.pointlist;t=d.pointlist;for(var e=g.length;e--;){var h=g[e];h.x_indoor=parseInt(h.x)/1E3;h.y_indoor=parseInt(h.y)/1E3}for(var e={},l=h=null,r=null,p=0;p<g.length;p++){var y=g[p],q=new L.Point(y.x_indoor,-y.y_indoor),K=L.CRS.EPSG3395.projection.unproject(q);y.floor.toLowerCase()!=h&&(l&&(l.next_floor=y.floor.toLowerCase(),l.endPOI={name:r,poiInfo:y,lastPoiInfo:g[p-1]}),h=y.floor.toLowerCase(),e[h]?(e[h].extend_points=[],q=h+"-1",e[h].extendRoute=q,e[q]={to_floor:null,endPOI:null,points:[]},e[q].floor=h,e[q].extend_points=e[h].points,l?e[q].prev_floor=l.floor:"",l=e[q],e[e[q].prev_floor].next_floor=q):(e[h]={to_floor:null,endPOI:null,points:[]},e[h].floor=h,l?e[h].prev_floor=l.floor:"",l=e[h]));r=y.poi_name;0==p&&(q=new L.Point(m.x_coord,m.y_coord),y=L.CRS.EPSG3395.projection.unproject(q),y.rt_attr=0,e[h].points.push(y));e[h].extend_points?(e[h].extend_points.push(K),q=e[h].extendRoute,e[q].points.push(K)):e[h].points.push(K);p==g.length-1&&(q=new L.Point(n.x_coord,n.y_coord),K=L.CRS.EPSG3395.projection.unproject(q),K.rt_attr=1,e[h].points.push(K))}(u=e)?k("successTrack",[u,d.distance]):"";window.Page.loading?window.Page.loading.show():"";m.floor!=a.Scene.getNowFloor()?a.Scene.changeFloorTo(m.floor):b();f&&f.hasfit&&A()}v=d;c?c(d):""}).error(function(a){c?c(a):""}).complete(function(){k("afterRequest")})}else H&&(y(),H=!1)}function b(b){var c=a.Scene.getNowFloor();if(u[c]){var d=u[c].points;z?a.Scene.removeLayer(z):"";x?a.Scene.removeLayer(x):"";E?a.Scene.removeLayer(E):"";C?a.Scene.removeLayer(C):"";C=null;"";F?a.Scene.removeLayer(F):"";D?a.Scene.removeLayer(D):"";G?a.Scene.removeLayer(G):"";J?a.Scene.removeLayer(J):"";if(0==d[0].rt_attr){var f=d[0],e=d[1];x=L.polyline([f,e],{color:"#1b1b60",dashArray:[5,5],weight:6,opacity:.8,className:"wha",renderer:L.svg()});a.Scene.addLayer(x);d=d.concat();d.splice(0,1)}1==d[d.length-1].rt_attr&&(f=d[d.length-2],e=d[d.length-1],u[c].extend_points&&(e=u[c].extend_points,f=e[e.length-2],e=e[e.length-1]),E=L.polyline([f,e],{color:"#1b1b60",dashArray:[5,5],weight:6,opacity:.8,className:"wha",renderer:L.svg()}),a.Scene.addLayer(E),d=d.concat(),d.splice(d.length-1,1));z=L.polyline(d,{color:"#1b1b60",weight:6,opacity:.8,className:"wha",renderer:L.svg()});z.setText("\uff1e",{repeat:!0,offset:3,attributes:{"letter-spacing":"20px",fill:"white","font-weight":"normal","font-size":"7"}});a.Scene.addLayer(z);u[c].extend_points&&(b?"":b=c+"-1",e=u[c].extend_points,C=L.polyline(e,{color:"#1b1b60",weight:6,opacity:.8,className:"wha",renderer:L.svg()}),C.setText("\uff1e",{repeat:!0,offset:3,attributes:{"letter-spacing":"20px",fill:"white","font-weight":"normal","font-size":"7"}}),a.Scene.addLayer(C),f=r(),f=p(f),J=L.marker(C.getLatLngs()[0],{icon:f}),a.Scene.addLayer(J),e=f=null,(d=u[b].endPOI)?(d.poiInfo?f=r(d.poiInfo):f=r(),e=p(f),G=L.marker(C.getLatLngs()[C.getLatLngs().length-1],{icon:e}),a.Scene.addLayer(G),d=g(d.poiInfo.desc),G.bindPopup(d,{autoPan:!1}).openPopup()):(f=r(),e=p(f),G=L.marker(C.getLatLngs()[C.getLatLngs().length-1],{icon:e}),a.Scene.addLayer(G)));z&&z._map&&((d=u[c].endPOI)&&d.poiInfo&&(f=r(d.poiInfo),f=p(f),e=new L.Point(d.lastPoiInfo.x_indoor,-d.lastPoiInfo.y_indoor),L.CRS.EPSG3395.projection.unproject(e),F=L.marker(z.getLatLngs()[z.getLatLngs().length-1],{icon:f}),a.Scene.addLayer(F),d=g(d.poiInfo.desc),F.bindPopup(d,{autoPan:!1}).openPopup()),n.floor.toUpperCase()!=m.floor.toUpperCase()&&Rtmap.Scene.getNowFloor().toUpperCase()!=m.floor.toUpperCase()&&(f=r(),f=p(f),D=L.marker(z.getLatLngs()[0],{icon:f}),a.Scene.addLayer(D)));H=!0;!b&&u[c].extend_points?k("drawPath",[u,z]):b&&0<b.indexOf("-")&&C?k("drawPath",[u,C]):k("drawPath",[u,z])}else k("drawPath")}function c(){m.Marker?a.Scene.removeLayer(m.Marker):"";for(var b in m)m[b]=null}function h(){n.Marker?a.Scene.removeLayer(n.Marker):"";for(var b in n)n[b]=null}function y(){z?a.Scene.removeLayer(z):"";x?a.Scene.removeLayer(x):"";E?a.Scene.removeLayer(E):"";C?a.Scene.removeLayer(C):"";B=null;F?a.Scene.removeLayer(F):"";D?a.Scene.removeLayer(D):"";G?a.Scene.removeLayer(G):"";J?a.Scene.removeLayer(J):""}function d(b,c,d){A();for(var e,g,h=0;h<t.length;h++)t[h].floor==b.floor&&t[h].x==b.x&&t[h].y==b.y&&(e=h),t[h].floor==c.floor&&t[h].x==c.x&&t[h].y==c.y&&(g=h);b=[];for(h=e;h<=g;h++)e=new L.Point(t[h].x_indoor,-t[h].y_indoor),e=L.CRS.EPSG3395.projection.unproject(e),b.push(e);f=L.polyline(b,{color:"#E80A0A",weight:6,opacity:.7,className:"wha",renderer:L.svg()});a.Scene.getNowFloor().toUpperCase()==d.toUpperCase()&&window.setTimeout(function(){f&&(a.Scene.getMap().fitBounds(f.getBounds().pad(.2)),a.Scene.addLayer(f),f.hasfit=!0);window.Page.loading?window.Page.loading.hide():""},700)}function A(){f&&f._map&&(a.Scene.removeLayer(f),f=null)}function p(a){return L.icon({iconUrl:a,iconRetinaUrl:a,iconSize:[30,30],iconAnchor:[15,15]})}function r(a){if(a){var b="up";a.desc&&(0<a.desc.indexOf("\u4e0a\u884c")&&(b="up"),0<a.desc.indexOf("\u4e0b\u884c")&&(b="down"));if(-1<a.poi_name.indexOf("\u7535\u68af"))return"./public/img/elevator_"+b+".png";if(-1<a.poi_name.indexOf("\u6276\u68af"))return"./public/img/escalator_"+b+".png";if(-1<a.poi_name.indexOf("\u697c\u68af"))return"./public/img/stair_"+b+".png"}return"./public/img/elevator.png"}function g(b){for(var c=a.Config.getFloorData(),d=0;d<c.length;d++)c[d].floor_alias&&(b=b.replace(c[d].floor,c[d].floor_alias));return b}var m={Poi:null,Marker:null,floor:null,x_coord:null,y_coord:null},n={Poi:null,Marker:null,floor:null},B=null,w={},t=null,u={},x=null,z=null,E=null,C=null,f=null,F=null,D=null,G=null,J=null,H=!1,v=null;a.Scene.on("drawedMap",function(c,d){m.Marker?a.Scene.removeLayer(m.Marker):"";n.Marker?a.Scene.removeLayer(n.Marker):"";z?a.Scene.removeLayer(z):"";x?a.Scene.removeLayer(x):"";E?a.Scene.removeLayer(E):"";C?a.Scene.removeLayer(C):"";F?a.Scene.removeLayer(F):"";D?a.Scene.removeLayer(D):"";u[c]?b(d):"";a.Config.getOption().largeScene&&"cdn"==a.Config.getOption().loadModel&&a.Scene.filterLayersByZoom();m.Marker&&c==m.floor&&a.Scene.addLayer(m.Marker);n.Marker&&c==n.floor&&a.Scene.addLayer(n.Marker);Page.wechat.clearLocationTargetLine?Page.wechat.clearLocationTargetLine():"";f&&f.hasfit&&A()});a.Scene.on("changeFloor",function(a,b){});return{on:function(a,b){w[a]||(w[a]=[]);w[a].push(b)},getStartPoi:function(){return m},getEndPoi:function(){return n},setStartPoi:function(a,b){if(!a&&Rtmap.Search.FocusResult)m.floor=Rtmap.Search.FocusResult.floor.toLowerCase(),m.x_coord=Rtmap.Search.FocusResult.x,m.y_coord=Rtmap.Search.FocusResult.y,m.Poi=Rtmap.Search.FocusResult;else{var c=a.feature?a.feature.properties:"";m.Poi=a;c?(m.floor=Rtmap.Scene.getNowFloor().toLowerCase(),m.x_coord=c.x_coord,m.y_coord=c.y_coord):(m.floor=a.floor.toLowerCase(),m.x_coord=a.x,m.y_coord=a.y)}(c=Rtmap.Scene.SelectMarker)?Rtmap.Scene.removeLayer(c,!0):"";Rtmap.Scene.SelectMarker=null;q(b);m.Poi==n.Poi&&h()},setStartPoiXY:function(a,b,c,d){m.floor=a.toLowerCase();m.x_coord=b;m.y_coord=c;m.Poi={};m.Poi.floor=a.toLowerCase();m.Poi.x=b;m.Poi.y=c;q()},clearStartPoi:c,clearEndPoi:h,getTrackStatus:function(){return H},setRoutePoints:function(a){B=a},setEndPoi:function(a,b){if(!a&&Rtmap.Search.FocusResult)n.floor=Rtmap.Search.FocusResult.floor.toLowerCase(),n.x_coord=Rtmap.Search.FocusResult.x,n.y_coord=Rtmap.Search.FocusResult.y,n.Poi=Rtmap.Search.FocusResult.y;else{var d=a.feature?a.feature.properties:"";n.Poi=a;d?(n.floor=Rtmap.Scene.getNowFloor().toLowerCase(),n.x_coord=d.x_coord,n.y_coord=d.y_coord):(n.floor=a.floor.toLowerCase(),n.x_coord=a.x,n.y_coord=a.y)}(d=Rtmap.Scene.SelectMarker)?Rtmap.Scene.removeLayer(d,!0):"";Rtmap.Scene.SelectMarker=null;l(a,b);m.Poi==n.Poi&&c();m.Poi||b||!Page.wechat.getLocaler()||(d=Page.wechat.getLocaler(),m.Poi=d,m.floor=d.floor.toLowerCase(),m.x_coord=d.x,m.y_coord=d.y)},setEndPoiXY:function(a,b,c,d){n.floor=a.toLowerCase();n.x_coord=b;n.y_coord=c;n.Poi={};n.Poi.x=b;n.Poi.y=c;n.floor.y=a.toLowerCase();l();!m.Poi&&Page.wechat.getLocaler()&&(a=Page.wechat.getLocaler(),m.Poi=a,m.floor=a.floor.toLowerCase(),m.x_coord=a.x,m.y_coord=a.y);e(d)},getRoutePoints:function(){return t},getRequestData:function(){return v},resetTrackLine:function(){z&&z._map&&(a.Scene.removeLayer(z),a.Scene.addLayer(z));x&&x._map&&(a.Scene.removeLayer(x),a.Scene.addLayer(x));E&&E._map&&(a.Scene.removeLayer(E),a.Scene.addLayer(E));C&&C._map&&(a.Scene.removeLayer(C),a.Scene.addLayer(C));f&&f._map&&(a.Scene.removeLayer(f),a.Scene.addLayer(f))},drawCTrackLine:function(b,c,f){window.locationModel="free";Rtmap.Control.disableLocal();a.Scene.getNowFloor().toUpperCase()!=f.toUpperCase()?(window.Page.loading?window.Page.loading.show():"",a.Scene.changeFloorTo(f,null,function(){d(b,c,f)})):d(b,c,f)},getCTrackLine:function(){return f},requestTrackFromServer:e,clearCTrackLine:A,clearPath:function(){"";c();h();y();A();u={};H=!1;k("clearPath")},clearAll:function(){c();h();this.clearPath()}}}();a.Search=function(){function q(a,c){if(e[a])for(var h=0;h<e[a].length;h++)e[a][h].apply(this,c)}function l(a){for(var c={},e=a.length,k=0;k<e;k++){var d=a[k],l=d.floor.toLocaleLowerCase();c[l]||(c[l]=[]);c[l].push(d)}return c}var k={},e={};return{request:function(b,c){var e={};e.key=Rtmap.Config.getOption().Key;var y=a.Config.getOption().Token;y?e.access_token=y:"";e.buildid=Rtmap.Config.getOption().buildId;e.keywords=b.keyword;e.floor=Rtmap.Scene.getNowFloor().toUpperCase();e.pagesize="30";e.pageindex=b.searchPageIndex;y=k.x&&k.y?k:Rtmap.Scene.getCenter();e.refer_point={x:y.x.toString(),y:y.y.toString()};var d=(new Date).getTime();q("beforeSearch",[d]);$.ajax({type:"POST",url:"http://lbsapi.rtmap.com/rtmap_lbs_api/v1/rtmap/search_keywords",data:JSON.stringify(e)}).done(function(a){if("0"==a.result.error_code){var d=l(a.poilist||[]);c?c(d,a,b):""}else alert(a.result.error_msg)}).complete(function(a){try{var c=JSON.parse(a.responseText);c.searchType=b.searchType}catch(e){console.log(e)}q("afterSearch",[c,d])})},searchTwoClass:function(a,c){var e={};e.buildid=Rtmap.Config.getOption().buildId;e.key=Rtmap.Config.getOption().Key;e.pagesize="999";e.pageindex="1";e.floor=Rtmap.Scene.getNowFloor().toUpperCase();e.classid=a;var k=Rtmap.Scene.getMap().getBounds().getCenter();e.refer_point={x:k.lat.toString(),y:k.lng.toString()};$.ajax({url:"http://lbsapi.rtmap.com/rtmap_lbs_api/v1/search_classification",type:"post",dataType:"json",data:JSON.stringify(e),success:function(a){if("0"==a.result.error_code){var b=l(a.poilist||[]);c?c(b,a):""}else alert(a.result.error_msg)}})},on:function(a,c){e[a]||(e[a]=[]);e[a].push(c)},setSearchPoint:function(a,c){k.x=a;k.y=c}}}();a.Animate=function(){return function(a){function l(){var b=(new Date).getTime();L.Util.requestAnimFrame(function(){var c=(new Date).getTime();a(c-b);k||e||l()})}var k=!1,e=!1;this.run=function(){k=!1;l()};this.stop=function(){k=!0};this.clear=function(){e=!0}}}();a.Config=function(){var a={buildId:null,service:"WFS",version:"1.0.0",request:"getFeature",maxFeatures:5E3,outputFormat:"text/javascript",defalutFloor:"f1",key:null,labelStyle:"standard",dataLoadModel:"cdn",largeScene:!1,scene:"",poiDetialType:"0"},l=[];return{setup:function(k){for(var e in k)a[e]=k[e]},getOption:function(){return a},setFloorData:function(a){l=a},getFloorData:function(){return l},getFloorAliasName:function(a){for(var e=0;e<l.length;e++)if(l[e].floor.toUpperCase()==a.toUpperCase()&&l[e].floor_alias)return l[e].floor_alias.toUpperCase();return a.toUpperCase()},getFloorDesc:function(a){for(var e=0;e<l.length;e++)if(l[e].floor.toUpperCase()==a.toUpperCase()&&l[e].desc)return l[e].desc;return""}}}();a.Location=function(){var a={_call:function(a,e){var b=this[a];if(b)for(var c=0;c<b.length;c++)b[c].apply(this,e)}},l=null;return{_setLocationData:function(k){a._call("haveLocation",[k])},_startHandler:function(a){l?l(a):""},_stopHandler:function(a){stopHandler?stopHandler(a):""},start:function(a){window.SDK_Location?(l=a,SDK_Location.start()):a("This function need Rtmap Native APP SDK!")},stop:function(a){window.SDK_Location?(stopHandler=a,SDK_Location.stop()):a("This function need Rtmap Native APP SDK!")},on:function(l,e){a[l]||(a[l]=[]);a[l].push(e)}}}();a.FeatureSelect=function(){function a(b){var c="";0<b.layers.length&&(c=b.layers[0].feature.properties.name_chinese);e=c+"_"+b.centerPoint.x.toString()+"_"+b.centerPoint.y.toString();window.jsObj&&window.jsObj.HtmlSendCenterPointLocationInfo(c,b.centerPoint.x.toString(),b.centerPoint.y.toString());window.HtmlSendCenterPointLocationInfoForIOS&&window.HtmlSendCenterPointLocationInfoForIOS(c,b.centerPoint.x.toString(),b.centerPoint.y.toString())}var l=L.Class.extend({includes:L.Mixin.Events,options:{icon:L.divIcon({iconSize:[64,64],iconAnchor:[32,32],className:"leaflet-feature-selector"}),selectSize:[64,64],featureGroup:null},initialize:function(a,c){L.setOptions(this,c);this._map=a;this.options.selectSize=L.point(this.options.selectSize)},enable:function(){this._enabled||(L.Handler.prototype.enable.call(this),this._center=this._map.getCenter(),this.layers={},this._marker=L.marker(this._center).addTo(this._map),this._map.on("zoomend",this._zoomEnd,this),this._map.on("drag",this._drag,this),this._map.on("dragend",this._dragEnd,this),this.options.featureGroup.on("layeradd",function(a){this._checkIntersections()},this),this.options.featureGroup.on("layerremove",function(a){this._handleNoIntersection(a.layer);this._checkIntersections()},this))},disable:function(){this._enabled&&(L.Handler.prototype.disable.call(this),this._map.off("zoomend",this._zoomEnd,this),this._map.off("drag",this._drag,this),this._map.off("dragend",this._dragEnd,this),this._map.removeLayer(this._marker))},addHooks:function(){var a=this._map;a&&(L.DomUtil.disableTextSelection(),a.getContainer().focus());this._map._container.style.cursor="default"},removeHooks:function(){this._map&&L.DomUtil.enableTextSelection();this._map._container.style.cursor=""},_handleIntersection:function(a){this.layers[L.stamp(a)]||(this.layers[L.stamp(a)]=a,this.justSelected.push(a))},_handleNoIntersection:function(a){this.layers[L.stamp(a)]&&(delete this.layers[L.stamp(a)],this.justUnselected.push(a))},_checkIntersections:function(a){if(a){a=this._map.options.crs.project(this._center);var c,e;this.justSelected=[];this.justUnselected=[];var l=this._map.options.crs,d=L.point(a.x+this.options.selectSize.x/2,a.y-this.options.selectSize.y/2),k=L.point(a.x-this.options.selectSize.x/2,a.y+this.options.selectSize.y/2),d=l.projection.unproject(d),l=l.projection.unproject(k);c=L.latLngBounds(d,l);e=L.rectangle(c).toGeoJSON().geometry.coordinates[0];this.options.featureGroup.eachLayer(function(a){var b=a.feature.geometry.coordinates,d,m=!1;switch(a.feature.geometry.type){case "Point":b=[b];case "MultiPoint":for(d=0;d<b.length;d++)c.contains(L.latLng([b[d][1],b[d][0]]))&&(m=!0);break;case "LineString":b=[b];case "MultiLineString":for(d=0;d<b.length;d++)c.intersects(a.getBounds())&&this._lineStringsIntersect(e,b[d])&&(m=!0);break;case "Polygon":b=[b];case "MultiPolygon":var l=this._map.options.crs.project(this._center);for(d=0;d<b.length;d++)c.intersects(a.getBounds())&&this._pointInPolygon(l.x,l.y,b[d][0])&&(m=!0)}if(!m)for(d=0;d<this.justSelected.length;d++)if(this.justSelected[d]==a){m=!0;break}m?this._handleIntersection(a):this._handleNoIntersection(a)},this);this.fire("unselect",{layers:this.justUnselected,centerPoint:a});this.fire("select",{layers:this.justSelected,centerPoint:a})}},_lineStringsIntersect:function(a,c){for(var e=0;e<=a.length-2;++e)for(var l=0;l<=c.length-2;++l){var d=a[e][1],k=a[e][0],p=a[e+1][1],r=a[e+1][0],g=c[l][1],m=c[l][0],n=c[l+1][1],q=c[l+1][0],w=(n-g)*(k-m)-(q-m)*(d-g),t=(p-d)*(k-m)-(r-k)*(d-g),d=(q-m)*(p-d)-(n-g)*(r-k);if(0!==d&&(w/=d,t/=d,0<=w&&1>=w&&0<=t&&1>=t))return!0}return!1},_pointInPolygon:function(a,c,e){var l=!1,d,k,p;k=0;for(p=e.length-1;k<e.length;p=k++){d=e[k][0];var r=e[k][1],g=e[p][0];p=e[p][1];(d=r>c!==p>c&&a<(g-d)*(c-r)/(p-r)+d)&&(l=!l)}return l},_mouseMove:function(a){this._marker.setLatLng(a.latlng);this._center=a.latlng},_drag:function(a){this._center=this._map.getCenter();this._marker.setLatLng(this._center)},_dragEnd:function(a){this._center=this._map.getCenter();this._marker.setLatLng(this._center);this._checkIntersections(a)},_zoomEnd:function(a){this._center=this._map.getCenter();this._marker.setLatLng(this._center);this._checkIntersections(a)}}),k,e;return{initCenterPoint:function(){var b=Rtmap.Scene.getMap();k&&(k.off("select",a),k.disable());k=new l(b,{featureGroup:Rtmap.Scene.getLayer(),selectSize:[16,16]});k.enable();k.on("select",a)},getCenterPointLoctionInfo:function(){return e}}}();a.WechatLocate=function(){var a=Array(50),l=Array(50),k=Array(50),e=Array(50);-1!=navigator.userAgent.indexOf("iPhone")?window.DeviceMotionEvent&&window.DeviceOrientationEvent?(window.addEventListener("devicemotion",function(b){var c={};b=b.accelerationIncludingGravity;c.GravityX=b.x;c.GravityY=b.y;c.GravityZ=b.z;a.timestamp=(new Date).getTime();a.push(c);a.shift()},!1),window.addEventListener("deviceorientation",function(a){var c={};c.alpha=a.alpha;c.beta=a.beta;c.gamma=a.gamma;c.heading=a.webkitCompassHeading;c.accuracy=a.webkitCompassAccuracy;l.timestamp=(new Date).getTime();l.push(c);l.shift()},!0)):alert("\u6d4f\u89c8\u5668\u4e0d\u652f\u6301"):-1!=navigator.userAgent.indexOf("Android")&&(window.DeviceMotionEvent&&window.DeviceOrientationEvent?(window.addEventListener("devicemotion",function(a){var c={};a=a.accelerationIncludingGravity;c.GravityX=a.x;c.GravityY=a.y;c.GravityZ=a.z;k.timestamp=(new Date).getTime();k.push(c);k.shift()},!1),window.addEventListener("deviceorientation",function(a){var c={};c.alpha=a.alpha;c.beta=a.beta;c.gamma=a.gamma;c.heading=a.webkitCompassHeading;c.accuracy=a.webkitCompassAccuracy;e.timestamp=(new Date).getTime();e.push(c);e.shift()},!0)):alert("\u6d4f\u89c8\u5668\u4e0d\u652f\u6301"));return{prepare:function(a){a&&"true"==a.debug?$("#show").css("display","block"):a&&"false"!=a.debug||$("#show").css("display","none");window.wechat.onScanStart=function(a){$("#show .timestamp").html(a.toString())};window.wechat.onScanSearch=function(a,b){var k={beacons:[]};if(-1!=navigator.userAgent.indexOf("iPhone")){var d=gSensor.getDiffStep(),q=gSensor.getStep(),p=0;0<d?p=1:"";window.wechat.param.locate_data.pdr={move_status:p,step:d};var r=window.compassStandard(l);window.wechat.param.locate_data.compass={standard:parseInt(r),average:parseInt(l[l.length-1].heading)};$("#show .step").html("\x3cp\x3e\u8ba1\u6b65\uff1a"+(d+p).toString()+"\u52a8\u9759\uff1a"+p.toString()+" \u89d2\u5ea6:"+((parseInt(l[l.length-1].heading)+window.getBuildAngle())%360).toString()+" \u65b0\u8ba1\u6b65:"+d+" \u603b\u6b65\u6570:"+q+"\x3c/p\x3e")}else if(-1!=navigator.userAgent.indexOf("Android")){d=gSensor.getDiffStep();q=gSensor.getStep();p=0;0<d?p=1:"";window.wechat.param.locate_data.pdr={move_status:p,step:d};var g=360-parseFloat(e[e.length-1].alpha),r=window.compassStandard(e);window.wechat.param.locate_data.compass={standard:parseInt(r),average:parseInt(g)};$("#show .step").html("\x3cp\x3e\u8ba1\u6b65\uff1a"+(d+p).toString()+"\u52a8\u9759\uff1a"+p.toString()+" \u89d2\u5ea6:"+((parseInt(g)+window.getBuildAngle())%360).toString()+" \u65b0\u8ba1\u6b65:"+d+" \u603b\u6b65\u6570:"+q+"\x3c/p\x3e")}for(d=0;d<a.beacons.length;d++)0!=a.beacons[d].rssi&&k.beacons.push(a.beacons[d]);if(0!=k.beacons.length){for(d=0;d<k.beacons.length-1;d++)for(q=0;q<k.beacons.length-1;q++)parseInt(k.beacons[q].rssi)<parseInt(k.beacons[q+1].rssi)&&(p=k.beacons[q],k.beacons[q]=k.beacons[q+1],k.beacons[q+1]=p);$("#show .wechat_text").html("\x3cp\x3e"+(new Date).toString()+JSON.stringify(k)+"\x3c/p\x3e");window.wechat.param.timestamp=(new Date).getTime();b(k)}};window.wechat.onPost=function(a){a.timestamp&&parseInt(a.timestamp)<parseInt(window.timeTmp)||(window.timeTmp=a.timestamp,$("#show .xy_text").html("\x3cp\x3e"+(new Date).toString()+JSON.stringify(a)+"\x3c/p\x3e"),$("#show .result_timestamp").append("\x3cp\x3e"+window.timeTmp+"\x3c/p\x3e"),Page.wechat.drawLocation(a,function(){}))};window.wechat.onScanStop=function(a){alert(JSON.stringify(a));$("#show .wechat_text").html("");$("#show .xy_text").html("")};window.wechat.onOverTime=function(){};window.wechat.init();$(".hide").click(function(){"0px"!=$("#show").css("width")?$("#show").css("width",0):$("#show").css("width","100%")});$(".doIt").click(function(){window.wechat.init()});$(".stopIt").click(function(){window.wechat.stopBeacons()})}}}();a.Parking=function(){function q(b){var c={};c.key=a.Config.getOption().Key;var e=a.Config.getOption().Token;e?c.access_token=e:"";c.buildid=a.Config.getOption().buildId;c.floor="B3";$.ajax({type:"POST",url:"http://lbsapitest2.rtmap.com:8080/rtmap_lbs_api/v1/rtmap/park_url",data:JSON.stringify(c),dataType:"json"}).done(function(a){b?b(a):""})}function l(a,b){$.ajax({type:"GET",url:a,dataType:"jsonp",jsonp:"callback",jsonpCallback:"parseResponse"}).done(function(a){b?b(a):""})}function k(){q(function(a){l(a.url,function(a){h=Rtmap.Scene.getTypeDataLayer();for(var b=0;b<a.data.length;b++){var c=a.data[b],e;for(e in h)for(var g=h[e].getLayers(),l=0;l<g.length;l++)g[l].feature.properties.name_chinese==c.parkspace&&(0==c.status?(g[l].setStyle(Rtmap.Style.getParkingStatusStyle().free),g[l].ParkingStatus="free"):1==c.status?(g[l].setStyle(Rtmap.Style.getParkingStatusStyle().busy),g[l].ParkingStatus="busy"):(g[l].setStyle(Rtmap.Style.getParkingStatusStyle().plan),g[l].ParkingStatus="plan"))}})})}function e(){c?window.clearInterval(c):"";b=!1}function b(){return b}var c=null,b=!1,h=null;return{updateParkingStatus:k,startMonitor:function(){setTimeout(function(){e();k();b=!0;c=setInterval(function(){k()},6E4)},1E3)},stopMonitor:e,isParkingStatus:b}}();return window.Rtmap=a});function rgbToHex(){for(var a="#",B=0;B<arguments.length;B++)a+=arguments[B].toString(16);console.log(a)}(function(){var a=L.Polyline.prototype.onAdd,B=L.Polyline.prototype.onRemove,D=L.Polyline.prototype._updatePath,q=L.Polyline.prototype.bringToFront;L.Polyline.include({onAdd:function(l){a.call(this,l);this._textRedraw()},onRemove:function(a){if((a=a||this._map)&&this._textNode){var k=this._map._pathRoot;k||(k=this._renderer._container);k.removeChild(this._textNode)}B.call(this,a)},bringToFront:function(){q.call(this);this._textRedraw()},_updatePath:function(){D.call(this);this._textRedraw()},_textRedraw:function(){var a=this._text,k=this._textOptions;a&&this.setText(null).setText(a,k)},_createElement:function(a){return document.createElementNS("http://www.w3.org/2000/svg",a)},setText:function(a,k){this._text=a;this._textOptions=k;if(!L.Browser.svg||"undefined"===typeof this._map)return this;k=L.Util.extend({repeat:!1,fillColor:"black",attributes:{},below:!1},k);if(!a){if(this._textNode&&this._textNode.parentNode){var e=this._map._pathRoot;e||(e=this._renderer._container);e.removeChild(this._textNode);delete this._textNode}return this}a=a.replace(/ /g,"\u00a0");var b="pathdef-"+L.Util.stamp(this),e=this._map._pathRoot;e||(e=this._renderer._container);this._path.setAttribute("id",b);if(k.repeat){var c=this._createElement("text"),h;for(h in k.attributes)c.setAttribute(h,k.attributes[h]);c.appendChild(document.createTextNode(a));e.appendChild(c);var q=c.getComputedTextLength();e.removeChild(c);a=Array(Math.ceil(this._path.getTotalLength()/q)).join(a)}var c=this._createElement("text"),q=this._createElement("textPath"),d=k.offset||this._path.getAttribute("stroke-width");q.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","#"+b);c.setAttribute("dy",d);for(h in k.attributes)c.setAttribute(h,k.attributes[h]);q.appendChild(document.createTextNode(a));c.appendChild(q);this._textNode=c;k.below?e.insertBefore(c,e.firstChild):e.appendChild(c);k.center&&(e=c.getComputedTextLength(),b=this._path.getTotalLength(),c.setAttribute("dx",b/2-e/2));if(this.options.clickable)for(!L.Browser.svg&&L.Browser.vml||q.setAttribute("class","leaflet-clickable"),L.DomEvent.on(c,"click",this._onMouseClick,this),e="dblclick mousedown mouseover mouseout mousemove contextmenu".split(" "),b=0;b<e.length;b++)L.DomEvent.on(c,e[b],this._fireMouseEvent,this);c.style.pointerEvents="none";return this}});L.LayerGroup.include({setText:function(a,k){for(var e in this._layers)"function"===typeof this._layers[e].setText&&this._layers[e].setText(a,k);return this}})})();(function(){try{var a=-1!=navigator.userAgent.indexOf("iPhone")?"iPhone":"Android";window.accessLogAppender=function(B,q){var l=(new Date).getTime();$.post("http://lbsapi.rtmap.com/rtmap_lbs_api/v1/rtmap/opt_log",JSON.stringify({key:q,timestamp:l,source:"\u673a\u573a",device_type:a,version:"3.0",opt:B}))}}catch(B){console.log(B)}})();(function(){var a=L.Icon.extend({options:L.extend({className:"leaflet-div-user-profile-icon",getIconUrl:function(){return"http://maps.rtmap.com/V3.1/public/js/vendor/leaflet/images/marker-user-profile.png"},userIconImgUrl:""},(new L.Icon.Default).options),initialize:function(a){L.extend(a,{shadowUrl:""});L.setOptions(this,a);a=this.options.getIconUrl();this._iconImg=this._createImg(a)},createIcon:function(){this._userIconImg=document.createElement("img");this._userIconImg.className="user-icon";this._userIconImg.src=this.options.userIconImgUrl;var a=document.createElement("div");a.appendChild(this._iconImg);a.appendChild(this._userIconImg);this._setIconStyles(a,"icon");this._iconImg.src=this.options.getIconUrl();L.DomUtil.addClass(this._iconImg,"leaflet-marker-user-profile-icon");return a}});window.Rtmap.Extend={createUserProfileMarker:function(B,D,q,l){l=new a({userIconImgUrl:l});return L.marker([D,q],{icon:l}).addTo(B)}}})();(function(){var a=L.Marker.prototype._initIcon,B=L.Marker.prototype._setPos,D="msTransform"===L.DomUtil.TRANSFORM;L.Marker.addInitHook(function(){var a=this.options.icon.options.iconAnchor;a&&(a=a[0]+"px "+a[1]+"px");this.options.rotationOrigin=this.options.rotationOrigin||a||"center bottom";this.options.rotationAngle=this.options.rotationAngle||0});L.Marker.include({_initIcon:function(){a.call(this)},_setPos:function(a){B.call(this,a);this.options.rotationAngle&&(this._icon.style[L.DomUtil.TRANSFORM+"Origin"]=this.options.rotationOrigin,this._icon.style[L.DomUtil.TRANSFORM]=D?" rotate("+this.options.rotationAngle+"deg)":this._icon.style[L.DomUtil.TRANSFORM]+(" rotateZ("+this.options.rotationAngle+"deg)"),(a=this._icon.getElementsByClassName("user-icon")[0])&&(a.style[L.DomUtil.TRANSFORM]=D?" rotate("+-this.options.rotationAngle+"deg)":" rotateZ("+-this.options.rotationAngle+"deg)"))},setRotationAngle:function(a){this.options.rotationAngle=a;this.update();return this},setRotationOrigin:function(a){this.options.rotationOrigin=a;this.update();return this}})})();