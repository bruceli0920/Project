/*
 rtmap.lbspoisdk, a JavaScript library for scan beacon to ask position in indoor maps. http://www.rtmap.com
 (c) 2015-2016, ludeliang[ip007@126.com]
 (v) 1.0.1
*/(function(){var f={version:"rtmap.lbspoisdk.1.0.1.js",scantype:"default",status:"ready",scanStart:(new Date).getTime(),scanTimeout:3E3,postTimeout:5E3,scanMin:5,scanMax:20,loadStart:(new Date).getTime(),loadTimeout:1E4,rssiMax:0,rssiMin:-100,period:3E3,beacons:[],wxsdk:"http://res.wx.qq.com/open/js/jweixin-1.1.0.js",signurl:"http://weix.rtmap.com/weixinapi/wxb5e69065eb3d67ce/jsapi_sign?url\x3d"+encodeURIComponent(window.location.href),pidurl:"http://weix.rtmap.com/mp/wxb5e69065eb3d67ce/token/ticket?ticket\x3d",lbsurl:"http://lbsapi.rtmap.com/rtmap_lbs_api/v1/rtmap/lbs_locateinfo",param:{user_id:"",user_id_desc:"lbs_webmap openid",brand:"",imei:"",key:"0KwOHEy7BQ",latitude:"",longitude:"",apinfo:[],beaconinfo:[],locate_data:{},need_poi:!1,timestamp:""},logs:[],onSign:function(){},onGetOpenid:function(){},onGetLocation:function(){},onScanStart:function(){},onScanSearch:function(){},onScanStop:function(){},beforePost:function(){},onPost:function(){},onOverTime:function(){},log:function(a){var b=new Date,b="["+b.getHours()+":"+b.getMinutes()+":"+b.getSeconds()+"]  ";this.logs.push(b+a)},getParam:function(a){a=new RegExp("(^|\x26)"+a+"\x3d([^\x26]*)(\x26|$)");a=window.location.search.substr(1).replace(/\?/g,"\x26").match(a);return null!=a?unescape(a[2]):null},load:function(a,b,d){var e=document.createElement("script");e.charset="utf-8";"function"==typeof b&&(e.readyState?e.onreadystatechange=function(){if("loaded"===e.readyState||"complete"===e.readyState)e.onreadystatechange=null,"function"==typeof b&&b()}:e.onload=function(){"function"==typeof b&&b()});e.src=a;a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(e,a)},post:function(a,b,d,e){var c=function(){var a;if(window.ActiveXObject)try{a=new ActiveXObject("Msxml2.XMLHTTP")}catch(b){try{a=new ActiveXObject("Microsoft.XMLHTTP")}catch(e){a=!1}}else window.XMLHttpRequest&&(a=new XMLHttpRequest);return a}();c.open(e||"POST",a,!0);c.setRequestHeader("Accept","*/*");c.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset\x3dUTF-8");c.onreadystatechange=function(){4==c.readyState&&200==c.status&&d(JSON.parse(c.responseText))};c.send(JSON.stringify(b)||null)},getOpenid:function(){var a=this,b=a.getParam("openid");if(b=(b=b?b:a.getParam("openId"))?b:a.getParam("op")?a.getParam("op").split(",")[0]:null)a.param.user_id=b,a.onGetOpenid(a.param.user_id);else{var b=a.getParam("ticket"),d="rtmaplbs_"+(new Date).getTime()+(9999*Math.random()>>0);window[d]=function(b){b.obj&&(a.param.user_id=b.obj.openId,a.onGetOpenid(a.param.user_id))};a.load(a.pidurl+b+"\x26callback\x3d"+d)}},getSign:function(){var a=this,b=this.signurl,d="rtmaplbs_"+(new Date).getTime()+(9999*Math.random()>>0);window[d]=function(b){wx.config({beta:!0,debug:!1,appId:b.obj.appid,timestamp:b.obj.timestamp,nonceStr:b.obj.nonceStr,signature:b.obj.signature,jsApiList:"startSearchBeacons stopSearchBeacons onSearchBeacons startMonitoringBeacons stopMonitoringBeacons onBeaconsInRange checkJsApi onMenuShareTimeline onMenuShareAppMessage onMenuShareQQ onMenuShareWeibo hideMenuItems showMenuItems hideAllNonBaseMenuItem showAllNonBaseMenuItem translateVoice startRecord stopRecord onRecordEnd playVoice pauseVoice stopVoice uploadVoice downloadVoice chooseImage previewImage uploadImage downloadImage getNetworkType openLocation getLocation hideOptionMenu showOptionMenu closeWindow scanQRCode chooseWXPay openProductSpecificView addCard chooseCard openCard".split(" ")});wx.ready(function(){a.signTicket=b.obj.jsapi_ticket;a.getBeacons();a.onSign(b)})};this.load(b+"\x26callback\x3d"+d)},getLocation:function(a){var b=this;wx.getLocation({type:"wgs84",success:function(a){b.param.latitude=a.latitude;b.param.longitude=a.longitude;b.onGetLocation(a)}})},getBeacons:function(){var a=this;wx.startSearchBeacons({ticket:a.signTicket,complete:function(b){a.status="ready";a.scanStart=(new Date).getTime();a.onScanStart(a.scanStart);wx.onSearchBeacons({complete:function(b){a.onScanSearch(b,function(b){if(b.beacons){for(var c=0,d=(new Date).getTime(),g=0;g<b.beacons.length;g++)if(c=Number(b.beacons[g].rssi),-100<c&&0>c&&(b.beacons[g].add_time=d,a.beacons.push(b.beacons[g]),a.beacons.length>a.scanMax)){a.beacons.shift();break}"ready"==a.status&&(a.beacons.length>=a.scanMin||(new Date).getTime()-a.scanStart>=a.scanTimeout)?(a.param.beaconinfo=a.beacons,a.postBeacons()):"sending"==a.status&&(new Date).getTime()-a.scanStart>=a.postTimeout&&(a.status="ready");if(!a.beacons.length&&(new Date).getTime()-a.loadStart>=a.loadTimeout)a.onOverTime()}})}})}})},filterBeacons:function(){if(Infinity===this.period)return!0;if("number"===typeof this.period){var a=(new Date).getTime();this.beacons=$.grep(this.beacons,function(b,d){return a-b.add_time<this.period})}},stopBeacons:function(){var a=this;wx.stopSearchBeacons({complete:function(b){a.status="stop";a.onScanStop(b)}})},postBeacons:function(){var a=this;a.filterBeacons();a.status="sending";a.scanStart=(new Date).getTime();a.param.timestamp=(new Date).getTime();a.beforePost(a.lbsurl,a.param);a.post(a.lbsurl,a.param,function(b){a.status="ready";a.onPost(b)})},getAttrInit:function(){for(var a="namespace scanTimeout loadTimeout postTimeout scanMax scanMin rssiMax rssiMin period".split(" "),b={},d=window.document.getElementsByTagName("script"),e=0;e<d.length;e++)for(var c=d[e].attributes,f=0;f<c.length;f++)(new RegExp(this.version)).test(c[f].nodeValue)&&(b=c);for(d=0;d<b.length;d++)e=b[d].nodeName,c=b[d].nodeValue,0<=a.toString().indexOf(e)&&(this[e]=Number(c)==c?Number(c):c)},init:function(){var a=this;a.getAttrInit();a.getOpenid();window.wx&&window.wx.startSearchBeacons?a.getSign():a.load(a.wxsdk,function(){a.getSign()})}};f.init();f.namespace&&(window[f.namespace]=f)})();