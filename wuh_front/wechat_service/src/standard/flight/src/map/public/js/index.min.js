var Page=window.Page||{},openId=null,debugTools=!1,locationModel="follow",userProfileImageUrl=null,userNickName=null;function getColorConfig(f){var h={key:Page.URL.getParameter("key")};$.ajax({type:"POST",url:"http://lbsapi.rtmap.com/rtmap_lbs_api/v1/rtmap/map_color",data:JSON.stringify(h)}).done(function(b){if(b.result.error_code){if(b.map_color&&b.map_color.colorData){for(var e in b.map_color.colorData){var d=b.map_color.colorData[e];Rtmap.Style.setPoiDefaultStyle(d.type,d)}Rtmap.Style.setImageConfig(b.map_color.imageData);Rtmap.Style.setGlobalConfig(b.map_color.globalData)}else{b=RTMAP_MAP_COLOR_CONFIG_ZHIHUITU.globalData;var a=RTMAP_MAP_COLOR_CONFIG_ZHIHUITU.imageData,k=RTMAP_MAP_COLOR_CONFIG_ZHIHUITU.colorData;for(e in k)d=k[e],Rtmap.Style.setPoiDefaultStyle(d.type,d);Rtmap.Style.setImageConfig(a);Rtmap.Style.setGlobalConfig(b)}e=Rtmap.Style.getGlobalConfig("canvas_color");$(".canvas").css({background:e})}f()})}function initializeLocalColorConfig(){var f=RTMAP_MAP_COLOR_CONFIG_ZHIHUITU.globalData,h=RTMAP_MAP_COLOR_CONFIG_ZHIHUITU.imageData,b=RTMAP_MAP_COLOR_CONFIG_ZHIHUITU.colorData;for(i in b){var e=b[i];Rtmap.Style.setPoiDefaultStyle(e.type,e)}Rtmap.Style.setImageConfig(h);Rtmap.Style.setGlobalConfig(f);f=Rtmap.Style.getGlobalConfig("canvas_color");$(".canvas").css({background:f})}$(document).ready(function(){openId=Page.URL.getParameter("openid");debugTools=Page.URL.getParameter("debug");window.initBuildAngle();initializeLocalColorConfig();Rtmap.Scene.initMapContext({parentDOM:"canvas"});Rtmap.Control.showZoom();Rtmap.Control.showScale();Rtmap.Control.showLocal(function(){accessLogAppender("opt_navi_button_click",Page.URL.getParameter("key"));var a=Page.Local.getLocaler();if(a)Rtmap.Scene.getNowFloor().toUpperCase()!=a.floor.toUpperCase()&&Rtmap.Scene.changeFloorTo(a.floor),Rtmap.Scene.moveTo(a);else if(a=Page.wechat.getLocaler())Rtmap.Scene.getNowFloor().toUpperCase()!=a.floor.toUpperCase()&&Rtmap.Scene.changeFloorTo(a.floor),Rtmap.Scene.moveTo(a),locationModel="follow",Rtmap.Control.enableLocal()});Rtmap.Control.disableLocal();Page.SearchControl=Rtmap.Control.showSearch();Page.FloorBtn=Rtmap.Control.showFloorChange();var f=Page.URL.getParameter("buildid"),h=Page.URL.getParameter("floor");h&&"B2M"==h.toUpperCase()&&(h="b1.5");var b=Page.URL.getParameter("key"),e=Page.URL.getParameter("token");if(b||e){var d=Page.URL.getParameter("capturemode");Page.capturemode=d;d=Page.URL.getParameter("labelstyle");Rtmap.Config.setup({buildId:f,defaultFloor:h||"f1",Key:b,Token:e,showLabelByStar:!0,PoiStart:{"\u5fd7\u613f\u8005\u670d\u52a1\u53f0":9},labelStyle:d});Page.Controller.bindGlobalEvent();Page.Controller.initMap();openId&&(Page.wechat.locateAlert(),debugTools?Rtmap.WechatLocate.prepare({debug:"true"}):Rtmap.WechatLocate.prepare({debug:"false"}),userProfileImageUrl=Page.URL.getParameter("headimgurl"),userNickName=Page.URL.getParameter("nickname"))}else alert("Need Key or Token")});(function(f){var h={};f.controllerHelper={up:function(b){h[b]=!0;$(".rtmap_zoom_box").addClass("moveUp");$(".rtmap_scale_box").addClass("moveUp")},down:function(b){delete h[b];b=!1;for(var e in h)b=!0;b||($(".rtmap_zoom_box").removeClass("moveUp"),$(".rtmap_scale_box").removeClass("moveUp"))}}})(window.Page);(function(f){var h=function(){return{getShow:function(b){var d=$("\x3cdiv/\x3e",{class:"alertBox"});d.text(b);$("body").append(d);return d},clearShow:function(b){b&&b.remove()}}}(),b=function(){function b(a){a.animate({opacity:.01},500,function(){a.html("").remove().css({opacity:1})})}var d=null;return{show:function(a,k){d=$("\x3cdiv/\x3e",{class:"dialog_label"});var c=$("\x3cdiv/\x3e",{class:"content",text:a});d.html("").css({opacity:1}).append(c);$("body").append(d);height=c[0].scrollHeight;c.css({"margin-top":-height/2+"px"});c.css({"text-shadow":"0 0 0"});k&&function(){var c=d;setTimeout(function(){b(c)},k)}();return d},close:b}}();f.Controller={bindGlobalEvent:function(){function b(){var c=Page.URL.getParameter("point");c&&(c=c.split(","),Rtmap.Scene.createMarker({x:parseFloat(c[0]),y:parseFloat(c[1])}));if(c=Page.URL.getParameter("points"))for(var c=JSON.parse(c),a=0;a<c.length;a++)Rtmap.Scene.createMarker({x:c[a][0],y:c[a][1]});try{var d=Page.URL.getParameter("route"),g=JSON.parse(d);if(g&&1<g.length)for(d=[],a=0;a<g.length;a++){var k=g[a];if(0<a&&a!=g.length-1)d.push({x:k[0],y:k[1],floor:k[2]});else if(0==a){var e={x:k[0],y:k[1],floor:k[2]};Rtmap.Scene.changeFloorTo(k[2])}else if(0<a&&a==g.length-1)var l={x:k[0],y:k[1],floor:k[2]};e?Rtmap.TrackFactory.setStartPoi(e):"";0<d.length?Rtmap.TrackFactory.setRoutePoints(d):"";l?Rtmap.TrackFactory.setEndPoiXY(l.floor,l.x,l.y,function(c){Page.Tip.set("all");window.__onTrackSuccess(c);$(".backBtn").hide()}):""}else g&&1==g.length&&(k=g[0],e={x:k[0],y:k[1],floor:k[2]},openId?Rtmap.TrackFactory.setEndPoi(e,"car"):window.setTimeout(function(){Rtmap.TrackFactory.setEndPoi(e);window.Page.RoutePlan&&window.Page.RoutePlan.show({x:e.x,y:e.y,floor:e.floor,poi_no:-1,name:"\u4f20\u5165\u7ec8\u70b9",type:"end"});window.Page.RoutePlan.pickupStart()},300))}catch(h){console.log(h)}try{var q=Page.URL.getParameter("endpoint_name");if(q){var v=Rtmap.Config.getOption().defaultFloor.toUpperCase(),m=Rtmap.Scene.getPoiByName(v,q);m&&window.setTimeout(function(){Rtmap.TrackFactory.setEndPoi(m);window.Page.RoutePlan&&(m.feature?window.Page.RoutePlan.show({x:m.feature.properties.x_coord,y:m.feature.properties.y_coord,floor:Rtmap.Scene.getNowFloor().toLowerCase(),poi_no:m.feature.properties.poi_no,name:m.feature.properties.name_chinese,type:"end"}):window.Page.RoutePlan.show({x:m.x,y:m.y,floor:m.floor.toLowerCase(),poi_no:m.poi_no,name:m.name,type:"end"}));window.Page.RoutePlan.pickupStart()},300)}}catch(f){console.log(f)}}function d(c){var a=Rtmap.Config.getOption().defaultFloor.toUpperCase(),b=Rtmap.Scene.getPoiByNum(a,c);b&&Page.Tip.show({layer:b,poiName:b.feature.properties.name_chinese,parentDOM:$("#infoBox"),start:function(){Rtmap.TrackFactory.setStartPoi(b)},end:function(){Rtmap.TrackFactory.setEndPoi(b)}})}var a=!0;Rtmap.DataProvider.getBuildInfo({},function(c,a){Rtmap.Config.setFloorData(a.floorinfo);var b=Rtmap.Scene.getNowFloor(),b=Rtmap.Config.getFloorAliasName(b);$(".rtmap_floor_btn").text(b);Page.FloorBtn.setData(a.floorinfo);$("\x3cdiv/\x3e",{text:a.name_chn,class:"build_name"});$(".searchInput").attr("placeholder","\u641c\u7d22\u5e97\u94fa   @"+a.name_chn);$("title[class\x3dbdn]").html(a.name_chn)});Rtmap.Scene.on("mapClick",function(c){Page.Tip.close()});Rtmap.Scene.on("BKClick",function(c){});var k=null;Rtmap.Scene.on("drawedMap",function(){var c=null,n=null;if(a){c=Page.URL.getParameter("zoom");try{n=JSON.parse(Page.URL.getParameter("center"))}catch(h){}(poiNo=Page.URL.getParameter("poino"))&&d(parseInt(poiNo));a=!1;b();n&&setTimeout(function(){Rtmap.Scene.moveTo({x:n[0],y:n[1]},c)});var g=Page.URL.getParameter("centerpoint");if(g){var f=g.split(",");setTimeout(function(){Rtmap.Scene.moveTo({x:parseFloat(f[0]),y:parseFloat(f[1])},c)})}Rtmap.Location.on("haveLocation",function(c){Page.Local.update(c.x,c.y,c.floor.toLowerCase())})}k?k():"";k=null;Page.SearchControl.isChangeToNearFloor&&(Page.Controller.DialogLabel.show("\u5f53\u524d\u697c\u5c42\u65e0\u8be5\u8bbe\u65bd\uff0c\u5df2\u4e3a\u60a8\u8df3\u8f6c\u81f3"+Page.SearchControl.changeToFloor+"\u5c42\u3002",2E3),Page.SearchControl.isChangeToNearFloor=!1);g=Rtmap.Scene.getNowFloor();-1<Rtmap.Config.getFloorDesc(g).indexOf("\u505c\u8f66\u573a")?Rtmap.Parking.startMonitor():Rtmap.Parking.stopMonitor()});Rtmap.Scene.on("mapDrag",function(c){Page.Local.changeModel("free");locationModel="free";Rtmap.Control.disableLocal()});var c=!1;Page.SearchControl.on("changeToNearFloor",function(a){c=!0;Page.SearchControl.changeToFloor=a.toUpperCase();Page.SearchControl.isChangeToNearFloor=!0});Page.SearchControl.on("markerSearchToMap",function(a,b){function d(){Page.SearchControl.clearSearchResult()}function g(){l?Rtmap.Scene.addLayer(l):"";for(var c=0;c<b.length;c++)if(b[c].selected){l=b[c];Rtmap.Scene.removeLayer(b[c]);break}}function e(c){Page.Tip.show({layer:Rtmap.Scene.getPoiByNum(c.floor,c.poi_no),poiName:c.name,parentDOM:$("#infoBox"),start:function(){var a=Rtmap.Scene.getPoiByNum(c.floor,c.poi_no);g();Rtmap.TrackFactory.setStartPoi(a)},end:function(){var a=Rtmap.Scene.getPoiByNum(c.floor,c.poi_no);g();Rtmap.TrackFactory.setEndPoi(a)},data:c})}Page.ClearBtn.show("Search");Page.ClearBtn.removeEvent(d);Page.ClearBtn.addEvent(d);for(var h=0;h<b.length;h++)(function(){var c=a[h];b[h].on("click",function(){e(c)})})();c?k=function(){e(a[0])}:e(a[0]);c=!1;var l;Page.ClearBtn.addEvent(function(){Page.Tip.close()});Rtmap.TrackFactory.getTrackStatus()&&(Rtmap.TrackFactory.clearPath(),Page.controllerHelper.down("TrackDashboard"),Page.TrackDashboard.close())});Page.SearchControl.on("searchFocus",function(c){Page.Tip.closeCusDetail()});Page.SearchControl.on("categoryBtn",function(c){Page.Tip.closeCusDetail()});Page.SearchControl.on("searchBtn",function(c){Page.Tip.closeCusDetail()});Page.SearchControl.on("clearSearchResult",function(c){Rtmap.TrackFactory.getTrackStatus()||Page.ClearBtn.close("Search")});(function(){var c={};Rtmap.Search.on("beforeSearch",function(a){c[a]=Page.Controller.DialogLabel.show("\u6b63\u5728\u641c\u7d22...")});Rtmap.Search.on("afterSearch",function(a,b){Page.Controller.DialogLabel.close(c[b]);(!a.poilist||1>a.poilist.length)&&Page.Controller.DialogLabel.show("\u6ca1\u6709\u627e\u5230\u76f8\u5173\u5e97\u94fa\u6216\u8bbe\u65bd",1E3)})})();Rtmap.Scene.on("changeFloor",function(c){$("#floorChange").html(c.toUpperCase()+"");c=Page.floorChange.getFloorInfo(c);$("#floorInfo").html(c+"");Page.Tip.close()});Rtmap.Scene.on("poiClick",function(c,a){if(a){var b=Rtmap.Scene.SelectMarker;b?Rtmap.Scene.removeLayer(b,!0):"";Page.Tip.show({layer:a,poiName:a.feature.properties.name_chinese,parentDOM:$("#infoBox"),start:function(){Rtmap.TrackFactory.setStartPoi(a)},end:function(){Rtmap.TrackFactory.setEndPoi(a)}});b=Rtmap.Style.getGlobalConfig("focus_icon_url");b=L.icon({iconUrl:b,iconRetinaUrl:b,iconSize:[30,30],iconAnchor:[15,30],shadowSize:[68,95],shadowAnchor:[22,94]});b=Rtmap.Scene.createMarker({x:a.feature.properties.x_coord,y:a.feature.properties.y_coord,icon:b});b.selected=!0;Rtmap.Scene.SelectMarker=b}else Page.Tip.close()})},initMap:function(){var b=Rtmap.Config.getOption().defaultFloor;Rtmap.Scene.changeFloorTo(b)},AlertLabel:h,DialogLabel:b}})(window.Page);(function(f){var h=!1,b=[],e={},d=$('\x3cdiv class\x3d"clearBtn clearSearch"\x3e\x3cimg src\x3d"./public/img/cleanup.png"\x3e\x3c/div\x3e'),a={};d.click(function(){for(var a in e)e[a]();for(a=0;a<b.length;a++)b[a]();h||(b.length=0);$(".tip_box").hide()});f.ClearBtn={show:function(b){a[b]=0;h=!0;$(".top_right_bar").append(d);d.show();$(".top_right_bar").show()},addEvent:function(a){b.push(a)},removeEvent:function(a){for(var c=0;c<b.length;c++)if(b[c].name==a.name){b.splice(c,1);break}},bind:function(a,c){e[a]=c},close:function(b){delete a[b];b=!1;for(var c in a)b=!0;b||(h=!1,d.hide())}}})(window.Page);(function(f){function h(b,a){b.click(function(){Rtmap.Scene.changeFloorTo(a.toLowerCase());return!1})}var b,e={};f.floorChange={changeFloor:function(){for(var d=$("\x3cul/\x3e",{class:"show_floor_list"}),a=0;a<b.length;a++){var e=$("\x3cli/\x3e",{class:"li"});e.append("\x3cdiv class\x3d'floor'\x3e"+b[a].floor+"\x3c/div\x3e");e.append("\x3cdiv class\x3d'desc'\x3e"+b[a].desc+"\x3c/div\x3e");d.append(e);h(e,b[a].floor)}$("#infoBox").html("").append(d)},setData:function(d){if(d.build_detail)for(b=d.build_detail.floorinfo,d=0;d<b.length;d++){var a=b[d].floor.toLowerCase();e[a]=b[d].desc}},getFloorInfo:function(b){b=b.toLowerCase();return e[b]}}})(window.Page);(function(f){function h(c){var a="",b="",g="",e="",h="";c.poi_image&&(a='\x3cdiv class\x3d"group"\x3e\x3cimg class\x3d"poi_image" src\x3d"'+c.poi_image+'" /\x3e\x3c/div\x3e');c.poi_descript&&(b='\x3cdiv class\x3d"group"\x3e\x3cp\x3e'+c.poi_descript+"\x3c/p\x3e\x3c/div\x3e");c.support_currecy&&(e='\x3cp class\x3d"poi_phone_list"\x3e\x3cspan\x3e\u652f\u6301\u8d27\u5e01:\x3c/span\x3e\x3cspan class\x3d"poi_phone"\x3e'+(c.support_currecy||"")+"\x3c/span\x3e\x3c/p\x3e");c.more&&(g='\x3ca class\x3d"more"\x3e\u66f4\u591a...\x3c/a\x3e');if(c.phone_number)for(var k=c.phone_number.split(","),f=0;f<k.length;f++)h+='\x3ca href\x3d"tel:'+k[f]+'"\x3e'+k[f]+"\x3c/a\x3e \x26nbsp;";w='\x3cdiv class\x3d"cus_detail"\x3e\x3cdiv class\x3d"detail_box"\x3e\x3cdiv class\x3d"poi_info"\x3e\x3cdiv class\x3d"group"\x3e\x3cdiv class\x3d"poi_logo"\x3e'+(c.poi_logo?"\x3cimg src\x3d"+c.poi_logo+"\x3e":"")+'\x3c/div\x3e\x3cspan class\x3d"poi_title"\x3e'+(c.poi_name||"")+'\x3c/span\x3e\x3cp class\x3d"poi_address_list"\x3e\x3cspan\x3e\u5730\u5740\uff1a\x3c/span\x3e\x3cspan class\x3d"poi_address"\x3e'+(c.poi_address||"")+'\x3c/span\x3e\x3c/p\x3e\x3cp class\x3d"poi_phone_list"\x3e\x3cspan\x3e\u7535\u8bdd\uff1a\x3c/span\x3e\x3cspan class\x3d"poi_phone"\x3e'+h+'\x3c/span\x3e\x3c/p\x3e\x3c/div\x3e\x3cdiv class\x3d"group"\x3e\x3cp class\x3d"poi_address_list"\x3e\x3cspan\x3e\u5206\u7c7b\uff1a\x3c/span\x3e\x3cspan class\x3d"poi_address"\x3e'+(c.business_type||"")+'\x3c/span\x3e\x3c/p\x3e\x3cp class\x3d"poi_phone_list"\x3e\x3cspan\x3e\u8425\u4e1a\u65f6\u95f4\uff1a\x3c/span\x3e\x3cspan class\x3d"poi_phone"\x3e'+(c.business_time||"")+"\x3c/span\x3e\x3c/p\x3e"+e+"\x3c/div\x3e"+a+b+g+"\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e";l?l.remove():"";l=$(w);l.find(".more").click(function(){d(c.more)})}function b(a){u?e():(h(a),u=!0,$("body").append(l),c.find(".detail_enter").find("i").removeClass("fa-angle-up").addClass("fa-angle-down"))}function e(){c.find(".detail_enter").find("i").removeClass("fa-angle-down").addClass("fa-angle-up");u=!1;l?l.remove():""}function d(c){p.html("").append('\x3cdiv class\x3d"back"\x3e\x3ci class\x3d"fa fa-close"\x3e\x3c/i\x3e\x3c/div\x3e\x3ciframe src\x3d""\x3e\x3c/iframe\x3e');p.find(".back").click(function(){p.remove()});p.find("iframe").attr("src",c);$("body").append(p)}function a(){if(g&&g.feature&&!g.ParkingStatus){var c=Rtmap.Classification.getLayerStyle(g);g.setStyle&&g.setStyle(c)}}function k(a){if(a.layer){var b=a.layer.feature.properties;e();if(Rtmap.Config.getOption().vendorDetailUrl)if("1"!=Rtmap.Config.getOption().poiDetialType)Page.PoiDetail.getVendorDetail(b,function(a){"0"==a.result.error_code&&(a.url?(c.find(".detail_enter").show(),c.find(".detail_enter").data("url",a.url),c.find(".detail_enter").data("type",a.type),c.find(".detail_enter").data("data",b)):0==b.classify_attr?c.find(".detail_enter").data("url",null).hide():c.find(".detail_enter").data("url",null).data("data",b).show())});else{a=Rtmap.Config.getOption().vendorDetailUrl;a=Rtmap.Config.getOption().buildId;var g=b.floor,d=b.poi_no;a=Rtmap.Config.getOption().vendorDetailUrl+"\x26build\x3d"+a+"\x26floor\x3d"+g+"\x26poi\x3d"+d;c.find(".detail_enter").show();c.find(".detail_enter").data("url",a);c.find(".detail_enter").data("type","html");c.find(".detail_enter").data("data",b)}else b.classify_attr&&0!=b.classify_attr&&c.find(".detail_enter").data("url",null).data("data",b).show()}}var c=$("\x3cdiv/\x3e",{class:"tip_box"}),p=$("\x3cdiv/\x3e",{class:"detail_Tip"}),n=null,r=null,g=null,t={color:"#844d8c",fillColor:"#c28dc4",weight:1,opacity:1,fillOpacity:1},w=null,l=null,u=!1;c.append('\x3cdiv class\x3d"top_bar"\x3e\x3cdiv class\x3d"title"\x3e\x3c/div\x3e\x3ci class\x3d"fa fa-close close"\x3e\x3c/i\x3e\x3cdiv class\x3d"detail_enter"\x3e\x3ci class\x3d"fa fa-angle-up"\x3e\x3c/i\x3e \u8be6\u60c5 \x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"btn_bar"\x3e\x3cdiv class\x3d"start"\x3e\x3ci class\x3d"fa fa-long-arrow-up"\x3e\x3c/i\x3e\u4ece\u8fd9\u91cc\u51fa\u53d1\x3c/div\x3e\x3cdiv class\x3d"end"\x3e\x3ci class\x3d"fa fa-long-arrow-down"\x3e\x3c/i\x3e\u53bb\u8fd9\u91cc\x3c/div\x3e\x3c/div\x3e');c.find(".close").click(function(){a();f.Tip.close()});c.find(".start").click(function(){n?n():"";c.hide();Page.Tip.set("all");a();f.Tip.close();Page.ClearBtn.show("Track");Page.ClearBtn.bind("clearPath",function(){Rtmap.TrackFactory.clearPath();Page.controllerHelper.down("Tip");Page.RoutePlan.reset();Page.Tip.set("all")});window.Page.RoutePlan&&(g.feature?window.Page.RoutePlan.show({x:g.feature.properties.x_coord,y:g.feature.properties.y_coord,floor:Rtmap.Scene.getNowFloor().toLowerCase(),poi_no:g.feature.properties.poi_no,name:g.feature.properties.name_chinese,type:"start"}):window.Page.RoutePlan.show({x:g.x,y:g.y,floor:g.floor.toLowerCase(),poi_no:g.poi_no,name:g.name,type:"start"}))});c.find(".end").click(function(){r?r():"";c.hide();Page.Tip.set("all");a();f.Tip.close();Page.ClearBtn.show("Track");Page.ClearBtn.bind("clearPath",function(){Rtmap.TrackFactory.clearPath();Page.controllerHelper.down("Tip")});window.Page.RoutePlan&&(g.feature?window.Page.RoutePlan.show({x:g.feature.properties.x_coord,y:g.feature.properties.y_coord,floor:Rtmap.Scene.getNowFloor().toLowerCase(),poi_no:g.feature.properties.poi_no,name:g.feature.properties.name_chinese,type:"end"}):window.Page.RoutePlan.show({x:g.x,y:g.y,floor:g.floor.toLowerCase(),poi_no:g.poi_no,name:g.name,type:"end"}))});c.find(".detail_enter").click(function(){Page.SearchControl.hideCategory();var c=$(this).data("url"),a=$(this).data("type"),g=$(this).data("data");c?"html"==a?d(c):"button"==a&&(g.classify_attr?Page.PoiDetail.getDetailData(g,function(a,g){a||(g.more=c,b(g))}):b({more:c,poi_name:g.name_chinese})):Page.PoiDetail.getDetailData(g,function(c,a){c||b(a)})});Rtmap.TrackFactory.on("drawPath",function(c,a){Page.SearchControl.clearSearchResult();a&&window.setTimeout(function(){Rtmap.TrackFactory.getCTrackLine()||Rtmap.Scene.getMap().fitBounds(a.getBounds().pad(.2))},350)});Rtmap.TrackFactory.on("clearPath",function(){Page.ClearBtn.close("Track");Page.controllerHelper.down("TrackDashboard")});Rtmap.TrackFactory.on("needStartPoi",function(){Page.Controller.DialogLabel.show("\u8bf7\u9009\u62e9\u8d77\u70b9",1E3)});(function(){Rtmap.TrackFactory.on("beforeRequest",function(c){});Rtmap.TrackFactory.on("afterRequest",function(){})})();f.Tip={show:function(b){Page.controllerHelper.up("Tip");a();(g=b.layer)&&!g.ParkingStatus?g.setStyle?g.setStyle(t):"":g=b.data;c.show();c.find(".title").text(b.poiName);c.find(".detail_enter").hide();k(b);n=b.start;r=b.end;$("body").append(c);$(".dashboardList").hide()},set:function(a){var b=c.find(".end"),g=c.find(".start");switch(a){case "start":b.hide();g.show().css({width:"100%"});break;case "end":b.show().css({width:"100%"});g.hide();break;default:g.show().css({width:"50%",display:"inline-block"}),b.show().css({width:"50%",display:"inline-block"})}Page.controllerHelper.down("Tip")},close:function(){var b=Rtmap.Scene.SelectMarker;b?Rtmap.Scene.removeLayer(b,!0):"";a();$(".dashboardList").show();c.hide();e();Page.controllerHelper.down("Tip")},closeCusDetail:e}})(window.Page);(function(f){f.PoiDetail={getDetailData:function(h,b){$.ajax({type:"post",url:"http://lbsapi.rtmap.com:8080/rtmap_lbs_api/v1/rtmap/classify_poiinfo",data:JSON.stringify({key:Page.URL.getParameter("key"),buildid:Rtmap.Config.getOption().buildId,floor:h.floor||"F2",poi_no:h.poi_no||"75",classify_id:h.classify_attr||"1"})}).done(function(e){0==e.result.error_code&&(b?b(null,e.poiinfo):"");b?b(e.result.error_msg):""})},getVendorDetail:function(h,b){$.ajax({type:"get",url:Rtmap.Config.getOption().vendorDetailUrl,data:{buildid:h.id_build,floor:h.floor,poi_no:h.poi_no},jsonp:"callback",jsonpCallback:"handler",dataType:"jsonp"}).done(function(e){b?b(e):""})}}})(Page);(function(f){function h(a,b,c){this.x=a;this.y=b;this.floor=c;var e=L.icon({iconUrl:"./public/img/position.png",iconRetinaUrl:"./public/img/position.png",iconSize:[30,30],iconAnchor:[15,30],shadowSize:[68,95],shadowAnchor:[22,94]});this.body=Rtmap.Scene.createMarker({icon:e,floor:c,fillOpacity:1,opacity:1,fillColor:"#0091FF",color:"#fff",weight:2,size:10,x:a,y:b})}var b=null,e=null,d=null;h.prototype.flashLoop=function(){var a=10,b=.2,c=this;this.scope.animate=new Rtmap.Animate(function(){a+=b;if(10>a||25<a)b=-b,a=10;c.scope.setRadius(a)})};h.prototype.updateLocation=function(a,b,c){this.x=a;this.y=b;this.floor=c;a=L.CRS.EPSG3395.projection.unproject(new L.Point(a,b));this.body.setLatLng(a);this.scope.setLatLng(a);console.log(this.floor,Rtmap.Scene.getNowFloor());this.floor==Rtmap.Scene.getNowFloor()&&(this.scope.bringToFront(),this.body.bringToFront(),console.log(1))};f.Local={update:function(a,f,c){if(e!=a||d!=f)parseFloat(e),parseFloat(d),e=a,d=f,null!=b?b.updateLocation(a,f,c):b=new h(a,f,c)},changeModel:function(b){"follow"==b&&Rtmap.Scene.moveTo({x:e,y:d})},stop:function(){""},setLocaler:function(){},getLocaler:function(){return b}}})(window.Page);(function(f){f.URL={getParameter:function(h,b){return decodeURIComponent(((new RegExp("[?|\x26]"+h+"\x3d([^\x26;]+?)(\x26|#|;|$)")).exec(b||location.search)||[,""])[1].replace(/\+/g,"%20"))||null}}})(window.Page);(function(f){function h(c,d,h){a={};a.x=c;a.y=d;a.floor=h;e&&null==e._map&&(e=null);if(e)f=L.CRS.EPSG3395.projection.unproject(new L.Point(c,d)),e.setLatLng(f),Rtmap.Scene.getNowFloor().toUpperCase()!=h.toUpperCase()&&Rtmap.Scene.removeLayer(e,!0);else if(Rtmap.Scene.getNowFloor().toUpperCase()==h.toUpperCase())if(window.userProfileImageUrl)try{var f=L.CRS.EPSG3395.projection.unproject(new L.Point(c,d));e=window.Rtmap.Extend.createUserProfileMarker(Rtmap.Scene.getMap(),f.lat,f.lng,window.userProfileImageUrl);Rtmap.Scene.addExistMarker(e,h)}catch(g){alert(g)}else f=L.icon({iconUrl:"./public/img/position.png",iconRetinaUrl:"./public/img/position.png",iconSize:[40,40],iconAnchor:[20,20],shadowSize:[68,95],shadowAnchor:[22,94]}),e=Rtmap.Scene.createMarker({icon:f,floor:h,fillOpacity:1,opacity:1,fillColor:"#0091FF",color:"#fff",weight:2,size:10,x:c,y:d});"follow"==locationModel&&(Rtmap.Scene.moveTo(a),Rtmap.Control.enableLocal(),Rtmap.Scene.getNowFloor().toUpperCase()!=a.floor.toUpperCase()&&Rtmap.Scene.changeFloorTo(a.floor));f=Page.URL.getParameter("route");(f=JSON.parse(f))?"":f=[];if((Page.URL.getParameter("endpoint_name")||1==f.length)&&!k&&Rtmap.TrackFactory.getEndPoi()){Rtmap.TrackFactory.setStartPoi(a);try{var t=Rtmap.TrackFactory.getEndPoi();t?Rtmap.TrackFactory.setEndPoiXY(t.floor,t.x_coord,t.y_coord,function(c){Page.Tip.set("all");window.__onTrackSuccess(c);$(".backBtn").hide()}):""}catch(w){}k=!0}b(c,d,h)}function b(c,b,a){c=L.CRS.EPSG3395.projection.unproject(new L.Point(c,b));d&&(Rtmap.Scene.removeLayer(d,!0),d=null);if(Rtmap.Scene.getNowFloor().toUpperCase()==a.toUpperCase()&&(a=Rtmap.TrackFactory.getEndPoi())&&a.floor)try{if(a.floor&&a.floor.toUpperCase()==Rtmap.Scene.getNowFloor().toUpperCase()){var e=L.CRS.EPSG3395.projection.unproject(new L.Point(a.x_coord,a.y_coord));a=[];a.push(c);a.push(e);d=L.polyline(a,{color:"red",opacity:1,weight:2});Rtmap.Scene.addLayer(d)}}catch(g){}}var e=null,d=null,a=null,k=!1;window.addEventListener("deviceorientation",function(a){if(e){var b=0,b=a.webkitCompassHeading?a.webkitCompassHeading:360-a.alpha;a=Math.round(b)+window.getBuildAngle();try{e.setRotationAngle(a)}catch(d){}}},!1);f.wechat={updateStartMarker:h,updateLocationTargetLine:b,clearLocationTargetLine:function(){d&&(Rtmap.Scene.removeLayer(d,!0),d=null)},stopLocation:function(){},getLocaler:function(){return a},drawLocation:function(a){0==a.result.error_code&&(clearTimeout(window.locateAlertTmp),h(a.lbsinfo.x,a.lbsinfo.y,a.lbsinfo.floor))},locateAlert:function(){window.locateAlertTmp=window.setTimeout(function(){Page.Controller.DialogLabel.show("\u5b9a\u4f4d\u9700\u8981\u84dd\u7259\uff0c\u8bf7\u786e\u8ba4\u662f\u5426\u5f00\u542f!",3E3)},1E4)}}})(Page);(function(f){var h,b=[],e=[],d=0,a=0,k=0,c=[],p=[Array(6),Array(6)],n=[],r=-1;e[0]=-(1/19.6133*240);e[1]=-(1/60*240);f.countStep=function(g){for(var f,k=h=0;k<g.length;k++){f=g[k];var l=0,u;for(u in f)var q=240+f[u]*e[1],l=l+q;q=l/3;f=q>b[0]?1:q<b[0]?-1:0;if(f==-c[0]){l=0<f?0:1;p[l][0]=b[0];var v=Math.abs(p[l][0]-p[1-l][0]);if(10<v){var m=n[0]>v/3,x=r!=1-l;v>2*n[0]/3&&m&&x?(d=(new Date).getTime(),300<d-a&&(h++,r=l,a=d)):r=-1}n[0]=v}c[0]=f;b[0]=q}return h};f.moveStatus=function(a){if(a.length){for(var b=0,c=0,e=0;e<a.length;e++){var d=0;if(a[e]){a[e].sq=0;for(var f in a[e])var h=parseFloat(a[e][f]),d=d+h*h;b+=Math.sqrt(d);a[e].sq=Math.sqrt(d)}}b/=a.length;for(e=0;e<a.length;e++)d=0,d=a[e].sq-b,c+=Math.pow(d,2);c/=a.length;return.2<c?1:0}return 1};f.compassStandard=function(a){function b(a){for(var c=0,e=parseFloat(a[0].alpha),d=0;d<a.length;d++)if(a[d]){var f=parseFloat(a[d].alpha)-e;180<f?f-=360:180>f&&(f+=360);c+=f+e}c/=a.length;0>c&&(c+=360);return c}function c(a,b){for(var e=0,d=0,f=0;f<a.length;f++)d=a[f].alpha-b,0>d&&(d=-d),180<d&&(d-=360),0>d&&(d=-d),e+=d*d;e/=a.length;return Math.sqrt(e)}if(a.length){var e=b(a);return c(a,e)}return 127};f.initBuildAngle=function(a){a=Page.URL.getParameter("buildid");var b=Page.URL.getParameter("key"),c=[];c.push(a);$.ajax({type:"post",url:"http://lbsapi.rtmap.com/rtmap_lbs_api/v1/rtmap/build_angle",dataType:"json",data:JSON.stringify({key:b,buildid_list:c})}).done(function(a){a.build_angle_list&&(k=a.build_angle_list[0].angle)})};f.getBuildAngle=function(){return k?parseInt(k):0}})(window);(function(){window.hashDirection={1:["./public/img/straight.png","\u76f4\u884c"],2:["./public/img/right_front.png","\u53f3\u524d"],3:["./public/img/right.png","\u53f3\u8f6c"],4:["./public/img/right_rear.png","\u53f3\u540e"],5:["./public/img/left_rear.png","\u5de6\u540e"],6:["./public/img/left.png","\u5de6\u8f6c"],7:["./public/img/left_front.png","\u5de6\u524d"],8:["./public/img/elevator_up.png","\u4e0a\u76f4\u68af"],9:["./public/img/elevator_down.png","\u4e0b\u76f4\u68af"],10:["./public/img/stair_up.png","\u4e0a\u6276\u68af"],11:["./public/img/stair_down.png","\u4e0b\u6276\u68af"]}})();(function(){window.__onTrackSuccess=function(f){1!=f.pointlist.length&&(window.__store=f,window.Page.TrackDashboard.show(f),window.createDetailPage(f),locationModel="free",Rtmap.Control.disableLocal())}})();