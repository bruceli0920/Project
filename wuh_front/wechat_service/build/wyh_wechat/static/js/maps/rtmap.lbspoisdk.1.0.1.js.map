{"version":3,"sources":["rtmap.lbspoisdk.1.0.1.js"],"names":["RTB","version","scantype","status","scanStart","Date","getTime","scanTimeout","postTimeout","scanMin","scanMax","loadStart","loadTimeout","rssiMax","rssiMin","period","beacons","wxsdk","signurl","encodeURIComponent","window","location","href","pidurl","lbsurl","param","user_id","user_id_desc","brand","imei","key","latitude","longitude","apinfo","beaconinfo","locate_data","need_poi","timestamp","logs","onSign","onGetOpenid","onGetLocation","onScanStart","onScanSearch","onScanStop","beforePost","onPost","onOverTime","log","l","t","tt","getHours","getMinutes","getSeconds","this","push","getParam","name","reg","RegExp","r","search","substr","replace","match","unescape","load","src","callback","sfile","document","createElement","charset","readyState","onreadystatechange","onload","snode","getElementsByTagName","parentNode","insertBefore","post","url","info","type","req","xmlobj","ActiveXObject","e","E","XMLHttpRequest","CreateXMLHttpRequest","open","setRequestHeader","JSON","parse","responseText","send","stringify","getOpenid","_this","openid","split","commonParam","userId","error","ticket","timeKey","Math","random","aData","obj","openId","getSign","data","wx","config","beta","debug","appId","appid","nonceStr","signature","jsApiList","ready","signTicket","jsapi_ticket","getBeacons","getLocation","success","res","startSearchBeacons","complete","argv","onSearchBeacons","jsonData","_rssi","add_time","i","length","Number","rssi","shift","postBeacons","filterBeacons","Infinity","now_time","$","grep","n","stopBeacons","stopSearchBeacons","getAttrInit","acceptAttr","attr","js","atts","j","test","index","val","toString","indexOf","init","namespace"],"mappings":"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","file":"../rtmap.lbspoisdk.1.0.1.js","sourcesContent":["/*\r\n rtmap.lbspoisdk, a JavaScript library for scan beacon to ask position in indoor maps. http://www.rtmap.com\r\n (c) 2015-2016, ludeliang[ip007@126.com]\r\n (v) 1.0.1\r\n*/\r\n(function() {\r\n    var RTB = {\r\n        version: \"rtmap.lbspoisdk.1.0.1.js\",\r\n        scantype: \"default\",                // 扫描方式\r\n        status: \"ready\",                  // 当前状态\r\n        scanStart: (new Date()).getTime(),   // 扫描开始时间\r\n        scanTimeout: 1000 * 3,                   // 扫描超时，默认3秒\r\n        postTimeout: 1000 * 5,                   // 请求定位接口超时\r\n        scanMin: 5,                        // 最少beacon数\r\n        scanMax: 20,                       // 最多beacon数\r\n        loadStart: (new Date()).getTime(),   // 加载开始时间\r\n        loadTimeout: 1000 * 10,                  // 加载超时\r\n        rssiMax: 0,                        // 信号强度范围小于0\r\n        rssiMin: -100,                     // 信号强度范围大于-100\r\n        period: 3000,                 // beacon 有效期\r\n        beacons: [],\r\n        wxsdk: \"http://res.wx.qq.com/open/js/jweixin-1.1.0.js\",  // 微信接口\r\n        signurl: \"http://weix.rtmap.com/weixinapi/wxb5e69065eb3d67ce/jsapi_sign?url=\" + encodeURIComponent(window.location.href),    // 微信签名接口\r\n        pidurl: \"http://weix.rtmap.com/mp/wxb5e69065eb3d67ce/token/ticket?ticket=\",   // 微信ticket换取openid接口\r\n        lbsurl: \"http://lbsapi.rtmap.com/rtmap_lbs_api/v1/rtmap/lbs_locateinfo\",// lbs定位接口 \"http://lbsapitest2.rtmap.com:8080/rtmap_lbs_api/v1/rtmap/lbs_locateinfo\"\r\n        param: {                         // 提交给lbs的参数\r\n            \"user_id\": \"\",\r\n            // \"user_id_desc\": window.navigator.userAgent, \r\n            \"user_id_desc\": \"lbs_webmap openid\",\r\n            \"brand\": \"\",\r\n            \"imei\": \"\",\r\n            \"key\": \"0KwOHEy7BQ\",\r\n            \"latitude\": \"\",\r\n            \"longitude\": \"\",\r\n            \"apinfo\": [],\r\n            \"beaconinfo\": [],\r\n            //不需要的时候不写\r\n            \"locate_data\": {\r\n                /*\r\n                 \"gps\":{\r\n                 \"longitude\":\"\",\r\n                 \"latitude\":\"\",\r\n                 \"accuracy\":\"\"\r\n                 },\r\n                 \"pdr\":{\r\n                 \"move_status\":\"\",\r\n                 \"step\":\"\"\r\n                 },\r\n                 \"compass\":{\r\n                 \"standard\":\"\",\r\n                 \"average\":\"\"\r\n                 },\r\n                 \"pressure\":\"\",\r\n                 \"locate_result\":{\r\n                 \"timestamp\":\"\",\r\n                 \"build_id\":\"\",\r\n                 \"floor_id\":\"\",\r\n                 \"x_before\":\"\",\r\n                 \"y_before\":\"\"\r\n                 }\r\n                 */\r\n            },\r\n            \"need_poi\": false,\r\n            \"timestamp\": \"\"\r\n        },\r\n        logs: [],\r\n        onSign: function () { },   // 签名成功回调\r\n        onGetOpenid: function () { },   // 获取openid回调\r\n        onGetLocation: function () { },   // 获取GPS定位信息回调s\r\n        onScanStart: function () { },   // 开始扫描beacon的回调\r\n        onScanSearch: function () { },   // 扫描beacon心跳回调\r\n        onScanStop: function () { },   // 结束扫描beacon时回调\r\n        beforePost: function () { },   // 开始提交beacon信息时回调\r\n        onPost: function () { },    // 提交beacon成功回调\r\n        onOverTime: function () { }    // 扫描超时情况下回调\r\n    };\r\n\r\n    RTB.log = function( l ){\r\n        var t = new Date();\r\n        var tt = \"[\" + t.getHours() + \":\" + t.getMinutes() + \":\" + t.getSeconds() + \"]  \";\r\n        this.logs.push( tt + l);\r\n    };\r\n    /**\r\n     * \r\n     * 获取链接上参数的值 \r\n     * @param {any} name\r\n     * @returns\r\n     */\r\n    RTB.getParam =function (name) {\r\n        var reg = new RegExp(\"(^|&)\" + name + \"=([^&]*)(&|$)\");\r\n        var r = window.location.search.substr(1).replace(/\\?/g,\"&\").match(reg);\r\n        if (r != null){\r\n            return unescape(r[2]);\r\n        }\r\n        return null;\r\n    };\r\n    /**\r\n     * \r\n     * 1.创建 script标签 引入js\r\n     * 2.在 js 引入成功后执行回调函数\r\n     * 3. 此方法仍可用来进行跨域请求处理的\r\n     * @param {any} src\r\n     * @param {any} callback\r\n     * @param {any} load 未使用\r\n     */\r\n    RTB.load = function(src, callback, load) {\r\n        var sfile = document.createElement(\"script\");\r\n        sfile.charset = \"utf-8\";\r\n        \r\n        if(typeof callback == \"function\"){\r\n            if(sfile.readyState){\r\n                sfile.onreadystatechange = function() {\r\n                    if (\"loaded\" === sfile.readyState || \"complete\" === sfile.readyState){\r\n                        sfile.onreadystatechange = null;\r\n                        typeof(callback)==\"function\" && callback();\r\n                    }\r\n                }\r\n            }else{\r\n                sfile.onload = function() {\r\n                    typeof(callback)==\"function\" && callback();\r\n                } \r\n            }\r\n        }\r\n        sfile.src = src;\r\n        var snode = document.getElementsByTagName(\"script\")[0];\r\n        snode.parentNode.insertBefore(sfile, snode)\r\n    };\r\n    // post Beacon 信息\r\n    RTB.post = function( url, info, callback, type ){\r\n        // 创建 XMLHttpRequest 对象\r\n        function CreateXMLHttpRequest(){\r\n            var xmlobj;\r\n            if(window.ActiveXObject){\r\n                try{\r\n                    xmlobj = new ActiveXObject(\"Msxml2.XMLHTTP\");\r\n                }catch(e){\r\n                    try{\r\n                        xmlobj = new ActiveXObject(\"Microsoft.XMLHTTP\");\r\n                    }catch(E){\r\n                        xmlobj = false;\r\n                    }\r\n                }\r\n            } else if (window.XMLHttpRequest) {\r\n                xmlobj = new XMLHttpRequest();\r\n            }\r\n            return xmlobj;\r\n        }\r\n        var req = CreateXMLHttpRequest();\r\n        req.open(type||\"POST\", url, true);  \r\n        req.setRequestHeader(\"Accept\",\"*/*\");\r\n        req.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded; charset=UTF-8\"); //设置请求头信息  \r\n        // req.onload = callback( req );\r\n        req.onreadystatechange = function(){\r\n            if(req.readyState == 4 && req.status == 200){\r\n                callback( JSON.parse( req.responseText ) );\r\n            }\r\n        }\r\n        req.send( JSON.stringify(info) || null );                                                //设置为发送给服务器数据  \r\n    };\r\n    // 获取 openId 作为 user_id\r\n    RTB.getOpenid = function(){\r\n        var _this = this;\r\n        var openid = _this.getParam(\"openid\");\r\n            openid = openid ? openid : _this.getParam(\"openId\");\r\n            openid = openid ? openid : ( _this.getParam(\"op\") ? _this.getParam(\"op\").split(\",\")[0] : null );\r\n            try {\r\n                openid = openid ? openid : commonParam.userId;\r\n            } catch (error) {\r\n                \r\n            }\r\n        if( openid ){\r\n            _this.param.user_id = openid;\r\n            _this.onGetOpenid( _this.param.user_id );\r\n        }else{\r\n            var ticket = _this.getParam(\"ticket\");\r\n            var timeKey = 'rtmaplbs_' + (new Date()).getTime() + (Math.random()*9999>>0);\r\n            window[ timeKey ] = function(aData){\r\n                if(aData.obj){\r\n                    _this.param.user_id = aData.obj.openId;\r\n                    _this.onGetOpenid( _this.param.user_id );\r\n                }\r\n            };\r\n            _this.load(_this.pidurl + ticket + '&callback=' + timeKey);\r\n        }\r\n    };\r\n    // 获取签名信息\r\n    RTB.getSign = function(){\r\n        var _this = this;\r\n        var url = this.signurl;\r\n        var timeKey = 'rtmaplbs_' + (new Date()).getTime() + (Math.random()*9999>>0);\r\n        window[ timeKey ] = function(data){\r\n            \r\n            wx.config({\r\n                beta:true,\r\n                debug: false,\r\n                appId:  data.obj.appid,\r\n                timestamp: data.obj.timestamp,\r\n                nonceStr: data.obj.nonceStr,\r\n                signature: data.obj.signature,\r\n                jsApiList: [\r\n                    'startSearchBeacons', \r\n                    'stopSearchBeacons', \r\n                    'onSearchBeacons', \r\n                    'startMonitoringBeacons', \r\n                    'stopMonitoringBeacons', \r\n                    'onBeaconsInRange', \r\n\r\n                    'checkJsApi',\r\n                    'onMenuShareTimeline',\r\n                    'onMenuShareAppMessage',\r\n                    'onMenuShareQQ',\r\n                    'onMenuShareWeibo',\r\n                    'hideMenuItems',\r\n                    'showMenuItems',\r\n                    'hideAllNonBaseMenuItem',\r\n                    'showAllNonBaseMenuItem',\r\n                    'translateVoice',\r\n                    'startRecord',\r\n                    'stopRecord',\r\n                    'onRecordEnd',\r\n                    'playVoice',\r\n                    'pauseVoice',\r\n                    'stopVoice',\r\n                    'uploadVoice',\r\n                    'downloadVoice',\r\n                    'chooseImage',\r\n                    'previewImage',\r\n                    'uploadImage',\r\n                    'downloadImage',\r\n                    'getNetworkType',\r\n                    'openLocation',\r\n                    'getLocation',\r\n                    'hideOptionMenu',\r\n                    'showOptionMenu',\r\n                    'closeWindow',\r\n                    'scanQRCode',\r\n                    'chooseWXPay',\r\n                    'openProductSpecificView',\r\n                    'addCard',\r\n                    'chooseCard',\r\n                    'openCard']\r\n            });\r\n            wx.ready(function(){\r\n                // wx.hideOptionMenu();\r\n                _this.signTicket = data.obj.jsapi_ticket;\r\n                // _this.getLocation();    // 获取经纬度\r\n                _this.getBeacons();     // 获取beacons\r\n                _this.onSign( data );\r\n            });\r\n        }\r\n        this.load( url + '&callback=' + timeKey );\r\n    };\r\n    // 获取经纬度信息\r\n    RTB.getLocation = function( ticket ){\r\n        var _this = this;\r\n        wx.getLocation({\r\n            type: 'wgs84',\r\n            success: function (res) {\r\n                _this.param.latitude = res.latitude;\r\n                _this.param.longitude = res.longitude;\r\n                _this.onGetLocation( res );\r\n            }\r\n        });\r\n    };\r\n    // 获取beacon信息\r\n    RTB.getBeacons = function(){\r\n            var _this = this;\r\n            // 开启beacon扫描\r\n            wx.startSearchBeacons({\r\n                ticket : _this.signTicket,\r\n                complete:function(argv){\r\n                    // 监听扫beacon事件\r\n                    _this.status = \"ready\";\r\n                    _this.scanStart = (new Date()).getTime();\r\n                    _this.onScanStart( _this.scanStart );\r\n                    wx.onSearchBeacons({\r\n                    complete: function (jsonData) {\r\n                        //将原处理变为回调函数执行，可以对微信返回数据做处理，做修改再执行\r\n                        _this.onScanSearch(jsonData, function (argv){ // argv onScanSearch 处理后过滤出来的数据\r\n                            if(argv.beacons){\r\n                                var _rssi = 0, add_time = (new Date()).getTime();\r\n                                for(var i = 0; i < argv.beacons.length; i++){\r\n                                    var _rssi = Number(argv.beacons[i].rssi);\r\n                                    if(_rssi > -100 && _rssi < 0){\r\n                                        argv.beacons[i][\"add_time\"] = add_time;\r\n                                        _this.beacons.push(argv.beacons[i]);\r\n                                        // 假如beacon数量超出一定范围\r\n                                        if( _this.beacons.length > _this.scanMax ){\r\n                                            _this.beacons.shift();\r\n                                            break;\r\n                                        }\r\n                                    }\r\n                                }\r\n                                // 判断是否满足提交条件\r\n                                if( _this.status==\"ready\" && \r\n                                    ((_this.beacons.length >= _this.scanMin) ||\r\n                                    ((new Date()).getTime()-_this.scanStart >= _this.scanTimeout)) ){\r\n                                        _this.param.beaconinfo = _this.beacons;\r\n                                        _this.postBeacons();\r\n                                }else if( _this.status==\"sending\" && ((new Date()).getTime()-_this.scanStart >= _this.postTimeout) ){\r\n                                    _this.status = \"ready\";\r\n                                }\r\n                                // 超时扫描不到beacon\r\n                                if(!_this.beacons.length && ((new Date()).getTime()-_this.loadStart >= _this.loadTimeout)){//\r\n                                    _this.onOverTime();\r\n                                }\r\n\r\n                            }\r\n                        });\r\n                        }\r\n                    });\r\n\r\n                }\r\n            });\r\n            \r\n    };\r\n    // 过滤不在有效期内的 beacons\r\n    RTB.filterBeacons = function(){\r\n        if( this.period === Infinity){\r\n            return true;\r\n        }else if( typeof(this.period)===\"number\" ){\r\n            var now_time = (new Date()).getTime();\r\n            this.beacons = $.grep(this.beacons, function(n,i){\r\n                return (now_time - n.add_time) < this.period;\r\n            });\r\n        }\r\n    };\r\n    // 停止扫描获取beacons\r\n    RTB.stopBeacons = function(){\r\n        var _this = this;\r\n        wx.stopSearchBeacons({\r\n            complete:function(res){\r\n                _this.status = \"stop\";\r\n                _this.onScanStop( res );\r\n            }\r\n        });\r\n    };\r\n    // 发送beacon信息\r\n    RTB.postBeacons = function(){\r\n        var _this = this;\r\n        _this.filterBeacons();\r\n        _this.status = \"sending\";\r\n        _this.scanStart = (new Date()).getTime();\r\n        _this.param.timestamp=(new Date()).getTime();\r\n        _this.beforePost( _this.lbsurl, _this.param );\r\n        _this.post( _this.lbsurl, _this.param, function(aData){\r\n            _this.status = \"ready\";\r\n            _this.onPost( aData );\r\n            // ...\r\n        });\r\n    };\r\n    /**\r\n     * 获取script上的参数\r\n     */\r\n    RTB.getAttrInit = function(){\r\n        var _this = this; // this = RTB\r\n        var acceptAttr = [\"namespace\", \"scanTimeout\", \"loadTimeout\", \"postTimeout\", \"scanMax\", \"scanMin\", \"rssiMax\", \"rssiMin\", \"period\"];\r\n        var attr = {};\r\n        var js = window.document.getElementsByTagName(\"script\");\r\n        for( var i=0; i<js.length; i++ ){\r\n            var atts = js[i][\"attributes\"];\r\n            for( var j=0; j<atts.length; j++ ){\r\n                // if( atts[j][\"nodeValue\"]==_this.version ){\r\n                if( (new RegExp( _this.version )).test( atts[j][\"nodeValue\"] ) ){\r\n                    attr = atts;\r\n                }\r\n            }\r\n        };\r\n        for( var index=0; index<attr.length; index++ ){\r\n            var key = attr[index][\"nodeName\"], val = attr[index][\"nodeValue\"]\r\n            if( acceptAttr.toString().indexOf( key ) >=0 ){\r\n                _this[key] = Number(val)==val ? Number(val) : val; //RTB[namespace....] = '';\r\n            }\r\n        }\r\n    };\r\n\r\n    // 初始化\r\n    RTB.init = function(){\r\n        var _this = this;\r\n        _this.getAttrInit();  // 获取参数配置\r\n        _this.getOpenid();    // 获取openId\r\n        // 获取微信签名\r\n        if( window['wx'] && window['wx']['startSearchBeacons'] ){\r\n            _this.getSign();\r\n        }else{ //没有微信依赖 则创建 微信依赖的script标签引入后 再获取签名\r\n            _this.load(_this.wxsdk, function(){ _this.getSign(); });\r\n        }\r\n    }\r\n\r\n    RTB.getAttrInit(); // 获取标签上的属性参数 用于将 RTB 暴露出去\r\n\r\n    if( RTB[\"namespace\"] ){\r\n        window[ RTB.namespace ] = RTB; \r\n    }\r\n})(); "]}