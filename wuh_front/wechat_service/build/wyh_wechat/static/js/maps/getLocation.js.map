{"version":3,"sources":["getLocation.js"],"names":["WechatLocate","iphoneMotionDataArr","iphoneOrientationDataArr","androidMotionDataArr","androidOrientationDataArr","_locationData","navigator","userAgent","indexOf","window","DeviceMotionEvent","DeviceOrientationEvent","addEventListener","eventData","iphoneData","accelerationGravity","accelerationIncludingGravity","acceleration","GravityX","x","GravityY","y","GravityZ","z","timestamp","Date","getTime","push","shift","alpha","beta","gamma","heading","webkitCompassHeading","accuracy","webkitCompassAccuracy","alert","androidData","prepare","data","wechat","onScanSearch","callback","filterAndSort","beacons","geolocation","getCurrentPosition","position","param","locate_data","gps","longitude","coords","latitude","step","countStep","moveStatus","pdr","move_status","standard","compassStandard","compass","parseInt","average","length","$","html","toString","parseFloat","i","rssi","j","tmp","onPost","timeTmp","init","locationData"],"mappings":"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","file":"../getLocation.js","sourcesContent":["WechatLocate = (function() {\r\n\t//iphone DeviceMotionEvent and  DeviceOrientationEvent\r\n\tvar iphoneMotionDataArr = [];\r\n\tvar iphoneOrientationDataArr = [];\r\n\t//Android DeviceMotionEvent\r\n\tvar androidMotionDataArr = [];\r\n\tvar androidOrientationDataArr = [];\r\n\tvar _locationData = null; //获取的位置数据\r\n\r\n\tif (navigator.userAgent.indexOf(\"iPhone\") != -1) {\r\n\t\tif (window.DeviceMotionEvent && window.DeviceOrientationEvent) {\r\n\t\t\twindow.addEventListener(\"devicemotion\", function(eventData) {\r\n\t\t\t\tvar iphoneData = {};\r\n\t\t\t\tvar accelerationGravity = eventData.accelerationIncludingGravity;\r\n\t\t\t\tvar acceleration = eventData.acceleration;\r\n\t\t\t\tiphoneData.GravityX = accelerationGravity.x;\r\n\t\t\t\tiphoneData.GravityY = accelerationGravity.y;\r\n\t\t\t\tiphoneData.GravityZ = accelerationGravity.z;\r\n\t\t\t\tiphoneMotionDataArr.timestamp = new Date().getTime();\r\n\t\t\t\tiphoneMotionDataArr.push(iphoneData);\r\n\t\t\t\tiphoneMotionDataArr.shift();\r\n\t\t\t}, false);\r\n\t\t\twindow.addEventListener(\"deviceorientation\", function(eventData) {\r\n\t\t\t\tvar iphoneData = {};\r\n\t\t\t\tiphoneData.alpha = eventData.alpha;\r\n\t\t\t\tiphoneData.beta = eventData.beta;\r\n\t\t\t\tiphoneData.gamma = eventData.gamma;\r\n\t\t\t\t//这里的heading是指北针的角度\r\n\t\t\t\tiphoneData.heading = eventData.webkitCompassHeading;\r\n\t\t\t\tiphoneData.accuracy = eventData.webkitCompassAccuracy;\r\n\t\t\t\tiphoneOrientationDataArr.timestamp = new Date().getTime();\r\n\t\t\t\tiphoneOrientationDataArr.push(iphoneData);\r\n\t\t\t\tiphoneOrientationDataArr.shift();\r\n\t\t\t}, true);\r\n\t\t} else {\r\n\t\t\talert(\"浏览器不支持\");\r\n\t\t}\r\n\t} else if (navigator.userAgent.indexOf(\"Android\") != -1) {\r\n\t\tif (window.DeviceMotionEvent && window.DeviceOrientationEvent) {\r\n\t\t\twindow.addEventListener(\"devicemotion\", function(eventData) {\r\n\t\t\t\tvar androidData = {};\r\n\t\t\t\tvar accelerationGravity = eventData.accelerationIncludingGravity;\r\n\t\t\t\tandroidData.GravityX = accelerationGravity.x;\r\n\t\t\t\tandroidData.GravityY = accelerationGravity.y;\r\n\t\t\t\tandroidData.GravityZ = accelerationGravity.z;\r\n\t\t\t\tandroidMotionDataArr.timestamp = new Date().getTime();\r\n\t\t\t\tandroidMotionDataArr.push(androidData);\r\n\t\t\t\tandroidMotionDataArr.shift();\r\n\t\t\t}, false);\r\n\t\t\twindow.addEventListener(\"deviceorientation\", function(eventData) {\r\n\t\t\t\tvar androidData = {};\r\n\t\t\t\tandroidData.alpha = eventData.alpha;\r\n\t\t\t\tandroidData.beta = eventData.beta;\r\n\t\t\t\tandroidData.gamma = eventData.gamma;\r\n\t\t\t\t//这里的heading是指北针的角度\r\n\t\t\t\tandroidData.heading = eventData.webkitCompassHeading;\r\n\t\t\t\tandroidData.accuracy = eventData.webkitCompassAccuracy;\r\n\t\t\t\tandroidOrientationDataArr.timestamp = new Date().getTime();\r\n\t\t\t\tandroidOrientationDataArr.push(androidData);\r\n\t\t\t\tandroidOrientationDataArr.shift();\r\n\t\t\t}, true);\r\n\t\t} else {\r\n\t\t\talert(\"浏览器不支持\");\r\n\t\t}\r\n\t}\r\n\r\n\tfunction _prepare(data) {\r\n\r\n\t\t/**\r\n\t\t * \r\n\t\t * 微信onSearchBeacons 监听周围 beacons成功时 实行的回调 \r\n\t\t * @param {any} data 监听周围beacons获取的 beacons数据\r\n\t\t * @param {any} callback 传入此方法的回调\r\n\t\t * @returns\r\n\t\t */\r\n\t\twindow.wechat.onScanSearch = function(data, callback) {\r\n\t\t\tvar filterAndSort = {\r\n\t\t\t\tbeacons:[] // 存储过滤后的 beacons\r\n\t\t\t};\r\n\t\t\t//GPS\r\n\t\t\tif (navigator.geolocation) {\r\n\t\t\t\tnavigator.geolocation.getCurrentPosition(function(position) {\r\n\t\t\t\t\tif (position) {\r\n\t\t\t\t\t\twindow.wechat.param.locate_data.gps = {\r\n\t\t\t\t\t\t\t\"longitude\": position.coords.longitude,\r\n\t\t\t\t\t\t\t\"latitude\": position.coords.latitude,\r\n\t\t\t\t\t\t\t\"accuracy\": position.coords.accuracy\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t//筛选设备然后做数据处理\r\n\t\t\t\t\t\tif (navigator.userAgent.indexOf(\"iPhone\") != -1) {\r\n\t\t\t\t\t\t\tvar step = window.countStep(iphoneMotionDataArr);\r\n\t\t\t\t\t\t\tvar moveStatus = window.moveStatus(iphoneMotionDataArr);\r\n\t\t\t\t\t\t\twindow.wechat.param.locate_data.pdr = {\r\n\t\t\t\t\t\t\t\tmove_status: moveStatus,\r\n\t\t\t\t\t\t\t\tstep: (step + moveStatus)\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tvar standard = window.compassStandard(iphoneOrientationDataArr);\r\n\t\t\t\t\t\t\twindow.wechat.param.locate_data.compass = {\r\n\t\t\t\t\t\t\t\t\"standard\": parseInt(standard),\r\n\t\t\t\t\t\t\t\t\"average\": parseInt(iphoneOrientationDataArr[iphoneOrientationDataArr.length - 1].heading)\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\t$(\"#show .step\").html(\"<p>\" + \"记步：\" + (step + moveStatus).toString() + \"动静：\" + moveStatus.toString() + \"</p>\");\r\n\t\t\t\t\t\t} else if (navigator.userAgent.indexOf(\"Android\") != -1) {\r\n\t\t\t\t\t\t\tvar step = window.countStep(androidMotionDataArr);\r\n\t\t\t\t\t\t\tvar moveStatus = window.moveStatus(androidMotionDataArr);\r\n\t\t\t\t\t\t\twindow.wechat.param.locate_data.pdr = {\r\n\t\t\t\t\t\t\t\tmove_status: moveStatus,\r\n\t\t\t\t\t\t\t\tstep: (step + moveStatus)\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tvar heading = (360 - parseFloat(androidOrientationDataArr[androidOrientationDataArr.length - 1].alpha))\r\n\t\t\t\t\t\t\tvar standard = window.compassStandard(androidOrientationDataArr);\r\n\t\t\t\t\t\t\twindow.wechat.param.locate_data.compass = {\r\n\t\t\t\t\t\t\t\t\"standard\": parseInt(standard),\r\n\t\t\t\t\t\t\t\t\"average\": parseInt(heading)\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\t$(\"#show .step\").html(\"<p>\" + \"记步：\" + (step + moveStatus).toString() + \"动静：\" + moveStatus.toString() + \"</p>\");\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// alert(JSON.stringify(window.wechat.param));\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tfor (var i = 0; i < data.beacons.length; i++) {\r\n\t\t\t\tif (data.beacons[i].rssi != 0) { // rssi 应该是信号强度\r\n\t\t\t\t\tfilterAndSort.beacons.push(data.beacons[i]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (filterAndSort.beacons.length == 0) {\r\n\t\t\t\treturn;\r\n\t\t\t} else {\r\n\t\t\t\t//从大到小排序\r\n\t\t\t\tfor (var i = 0; i < filterAndSort.beacons.length - 1; i++) {\r\n\t\t\t\t\tfor (var j = 0; j < filterAndSort.beacons.length - 1; j++) {\r\n\t\t\t\t\t\tif (parseInt(filterAndSort.beacons[j].rssi) < parseInt(filterAndSort.beacons[j + 1].rssi)) {\r\n\t\t\t\t\t\t\tvar tmp = filterAndSort.beacons[j];\r\n\t\t\t\t\t\t\tfilterAndSort.beacons[j] = filterAndSort.beacons[j + 1];\r\n\t\t\t\t\t\t\tfilterAndSort.beacons[j + 1] = tmp;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\twindow.wechat.param.timestamp = new Date().getTime();\r\n\r\n\t\t\t\tcallback(filterAndSort); //过滤出来的数据 传入回调函数中\r\n\t\t\t}\r\n\t\t};\r\n\t\t/**\r\n\t\t * \r\n\t\t * 请求定位接口成功后调用的函数\r\n\t\t * @param {any} data 获取的位置数据\r\n\t\t * @returns\r\n\t\t */\r\n\t\twindow.wechat.onPost = function(data) {\r\n\t\t\tif (data.timestamp && parseInt(data.timestamp) < parseInt(window.timeTmp)) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\twindow.timeTmp = data.timestamp;\r\n\t\t\t_locationData = data;\r\n\t\t};\r\n\t\t// 开启签名获取-> 扫描beacon->获取位置处理\r\n\t\twindow.wechat.init();\r\n\t}\r\n\r\n\treturn {\r\n\t\tprepare: _prepare, // 开启位置获取\r\n\t\tlocationData: function(){ // 返回位置数据\r\n\t\t\treturn _locationData;\r\n\t\t}\r\n\t};\r\n})();"]}